# Project State

## Project Reference

See: .planning/PROJECT.md (updated 2026-01-26)

**Core value:** Real-time hex crawl exploration with fog of war -- the DM controls what players see, and when hexes are revealed, every connected player sees it instantly.
**Current focus:** Phase 4 - Fog of War in progress.

## Current Position

Phase: 4 of 8 (Fog of War)
Plan: 4 of 4 in current phase
Status: Phase complete
Last activity: 2026-01-31 - Completed 04-04-PLAN.md

Progress: [████████████████] ~64% (16 of ~25 total plans)

## Performance Metrics

**Velocity:**
- Total plans completed: 15
- Average duration: 5min
- Total execution time: ~83min

**By Phase:**

| Phase | Plans | Total | Avg/Plan |
|-------|-------|-------|----------|
| 01-hex-grid-foundation | 4/4 | 33min | 8min |
| 02-server-authentication | 4/4 | 26min | 7min |
| 03-real-time-infrastructure | 4/4 | ~15min | ~4min |
| 04-fog-of-war | 4/4 | 17min | 4min |

**Recent Trend:**
- Last 5 plans: 5min, 12min, 7min, 2min, 3min
- Trend: consistent

*Updated after each plan completion*

## Accumulated Context

### Decisions

Decisions are logged in PROJECT.md Key Decisions table.
Recent decisions affecting current work:

- [Roadmap]: Multi-scale zoom (ZOOM-01/02/03), encounter tables (ENC-01/02), terrain painting (PAINT-01), and travel/weather mechanics deferred to v2
- [Roadmap]: Phase 6 (Map Image Upload) depends only on Phase 1, enabling parallel execution with Phases 2-5
- [01-01]: Flat-top hex orientation (Orientation.FLAT) following D&D convention
- [01-01]: 40px circumradius default for hex size
- [01-01]: topLeft origin + offset -1 for PixiJS sprite alignment
- [01-01]: JSON format for map import/export (no YAML dependency)
- [01-01]: Tailwind CSS v4 via @tailwindcss/vite plugin (CSS-first config)
- [01-01]: Zustand stores use new Map/Set instances for reactivity
- [01-02]: Sprite-based rendering with pre-generated textures for 60 FPS at 500+ hexes
- [01-02]: Offscreen Canvas 2D for runtime texture generation (no external asset pipeline)
- [01-02]: pixi-viewport registered as custom JSX component via extend({ Viewport })
- [01-02]: Imperative Graphics management for grid lines (avoiding @pixi/react draw callback limitation)
- [01-02]: Viewport culling via AABB bounds check per tick with threshold-based recalculation
- [01-02]: Seeded PRNG (mulberry32) for deterministic terrain noise patterns per variant
- [01-03]: Seed-and-grow BFS with ~15% seed rate, distance-decay growth (70/50/30/15%)
- [01-03]: Post-processing pass ensures water-coast adjacency after BFS
- [01-03]: 6 primary terrain seeds; coast generated by adjacency rules
- [01-03]: SidePanel tabs: Info, Terrain, Create, Import/Export
- [01-03]: Tailwind dark theme: bg-gray-800/700 panels, bg-gray-900 main, text-gray-100/200/300
- [01-04]: Module-level viewport ref (ViewportContext.tsx) for cross-component access (PixiJS reconciler doesn't support React context)
- [01-04]: HTML canvas addEventListener for pointer events with viewport.toWorld coordinate conversion
- [01-04]: Shift+drag area selection with viewport drag plugin pause/resume
- [01-04]: Graphics for dynamic highlight overlays, Sprites for static terrain tiles
- [01-04]: 5px click-vs-drag threshold to prevent accidental selection during pan
- [02-01]: Manual Better Auth schema (CLI incompatible with ESM barrel .js imports via jiti CJS resolver)
- [02-01]: drizzle.config.ts uses explicit schema file array (not barrel index.ts) for same CJS/ESM reason
- [02-02]: Extensionless imports in schema files (./auth not ./auth.js) for drizzle-kit CJS resolver compatibility
- [02-02]: AppVariables type exported from app.ts for route-level type safety
- [02-02]: Campaign creation + DM member insert wrapped in db.transaction() for atomicity
- [02-03]: AuthGuard uses state toggle (useState) for login/signup switching, not React Router
- [02-03]: Logout button as fixed top-right overlay to avoid modifying MapView component
- [02-03]: Forgot password link is placeholder alert (email infrastructure not yet configured)
- [02-03]: Inline error display maps error message keywords to specific form fields
- [02-04]: Vite proxy with origin rewrite replaces direct cross-origin CORS for dev
- [02-04]: Invitations router mounted at /api with full paths inside (no conflict with /api/campaigns)
- [02-04]: View-state navigation with useState enum (campaigns|dashboard|map) instead of router library
- [03-01]: Hono<any> type parameter for WS setup/handler to accommodate AppVariables generic
- [03-01]: Origin validation allows no-Origin connections (browser WS always sends it, CLI may not)
- [03-01]: Campaign membership verified once at WS upgrade, not per-message
- [03-01]: WS close codes: 4001=Unauthorized, 4002=Missing campaignId, 4003=Forbidden/Not member
- [03-02]: No broadcast_mode_change event logging since session_event_type enum lacks matching value; mode change reflected in room state
- [03-02]: Empty rooms in waiting/ended state auto-cleaned on last client disconnect; active/paused rooms preserved
- [03-02]: broadcastToAll for dm:preparing notification since both DM and players need broadcast mode signal
- [03-03]: sendMessage exposed via Zustand store (not hook return) for cross-component access
- [03-03]: Intentional WS close nulls onclose handler to prevent reconnection loop on cleanup
- [03-03]: Session overlay z-index layers: z-[100] connection banner, z-[90] session overlays, z-[80] subtle indicators
- [03-04]: Dev-mode origin permissiveness: CORS, WS origin, and Better Auth trustedOrigins all accept any origin when NODE_ENV !== production
- [03-04]: ALLOWED_ORIGINS env var for production origin configuration (comma-separated)
- [03-04]: StrictMode WS guard: server closes old socket on replacement (code 4000), skips stale onClose events
- [03-04]: Pause overlay shown only to players so DM retains access to resume/end controls
- [03-04]: Sign Out button offset to right-[316px] in map view to clear SidePanel
- [04-01]: "__all__" sentinel string for hex_visibility.user_id instead of NULL (PostgreSQL NULL uniqueness issue)
- [04-04]: Map data fetched via GET /api/campaigns/:id/map after session:state in useWebSocket
- [04-04]: loadFromServer derives gridWidth/gridHeight from hex coordinate bounds

### Pending Todos

None yet.

### Blockers/Concerns

None yet.

## Session Continuity

Last session: 2026-01-31
Stopped at: Completed 04-04-PLAN.md (Phase 4 complete)
Resume file: None
Next: Phase 5
