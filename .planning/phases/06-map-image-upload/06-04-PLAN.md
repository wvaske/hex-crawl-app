---
phase: 06-map-image-upload
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - packages/server/src/ws/handlers.ts
  - packages/client/src/stores/useSessionStore.ts
  - packages/client/src/canvas/layers/GridLineLayer.tsx
  - packages/client/src/canvas/layers/TerrainLayer.tsx
  - packages/client/src/hooks/useWebSocket.ts
autonomous: false

must_haves:
  truths:
    - "When DM uploads/deletes/reorders a layer, all connected players see the change in real time"
    - "Players only see layers where playerVisible is true"
    - "Grid renders as wireframe-only when map has image layers (no terrain fill by default)"
    - "Terrain overlay opacity is DM-configurable via slider"
    - "Grid line color and thickness are DM-configurable and render correctly"
    - "Fog of war renders on top of map images (unrevealed hexes hide image for players)"
    - "Coordinate labels always shown even over map images"
  artifacts:
    - path: "packages/server/src/ws/handlers.ts"
      provides: "WS broadcast for layer:added/updated/removed"
    - path: "packages/client/src/canvas/layers/GridLineLayer.tsx"
      provides: "Configurable grid line rendering (color, thickness, opacity)"
  key_links:
    - from: "packages/server/src/routes/map-images.ts"
      to: "packages/server/src/ws/handlers.ts"
      via: "broadcast layer changes after REST mutations"
    - from: "packages/client/src/hooks/useWebSocket.ts"
      to: "packages/client/src/stores/useImageLayerStore.ts"
      via: "layer:added/updated/removed handlers update store"
    - from: "packages/client/src/canvas/layers/GridLineLayer.tsx"
      to: "packages/client/src/stores/useImageLayerStore.ts"
      via: "reads grid style settings for line color/thickness/opacity"
---

<objective>
Wire real-time layer sync via WebSocket, implement configurable grid line rendering (wireframe mode over images), terrain overlay opacity control, and verify end-to-end integration including fog of war rendering order.

Purpose: Completes the phase by connecting all pieces: real-time sync, visual appearance controls, and correct rendering order.
Output: Full working map image upload feature with real-time sync and grid customization.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-map-image-upload/06-RESEARCH.md
@.planning/phases/06-map-image-upload/06-CONTEXT.md
@.planning/phases/06-map-image-upload/06-01-SUMMARY.md
@.planning/phases/06-map-image-upload/06-02-SUMMARY.md
@.planning/phases/06-map-image-upload/06-03-SUMMARY.md
@packages/server/src/ws/handlers.ts
@packages/client/src/hooks/useWebSocket.ts
@packages/client/src/canvas/layers/GridLineLayer.tsx
@packages/client/src/canvas/layers/TerrainLayer.tsx
@packages/client/src/canvas/layers/FogLayer.tsx
@packages/client/src/stores/useSessionStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebSocket layer sync + grid style rendering</name>
  <files>
    packages/server/src/ws/handlers.ts
    packages/server/src/routes/map-images.ts
    packages/client/src/hooks/useWebSocket.ts
    packages/client/src/stores/useSessionStore.ts
    packages/client/src/canvas/layers/GridLineLayer.tsx
    packages/client/src/canvas/layers/TerrainLayer.tsx
  </files>
  <action>
    1. **Server WS broadcasting** — In `map-images.ts` routes (or a helper), after successful POST/PATCH/DELETE on image layers, broadcast to the campaign's WS room:
       - layer:added (with full layer object, filtered by playerVisible for non-DM clients)
       - layer:updated (with layerId + changed fields, filtered)
       - layer:removed (with layerId)
       - map:updated (when grid settings change via PATCH map)
       Access the SessionManager or broadcast function from the server context (follow the pattern used by fog/token handlers).

    2. **Client WS handling** — In `useWebSocket.ts`, add message handlers:
       - layer:added → useImageLayerStore.getState().addLayer(msg.layer)
       - layer:updated → useImageLayerStore.getState().updateLayer(msg.layerId, msg.updates)
       - layer:removed → useImageLayerStore.getState().removeLayer(msg.layerId)
       - map:updated → update grid settings in appropriate store

    3. **GridLineLayer** — Modify to read grid style from the current map's settings (stored in a store or passed as props):
       - Use gridLineColor instead of hardcoded color
       - Use gridLineThickness for line width
       - Use gridLineOpacity for alpha
       - When map has image layers, default to wireframe-only appearance (these settings already control this)

    4. **TerrainLayer** — Modify to support configurable opacity:
       - Read terrainOverlayEnabled and terrainOverlayOpacity from map settings
       - When terrainOverlayEnabled is false, render terrain sprites with alpha=0 (invisible) but keep coordinate labels visible
       - When enabled, render terrain sprites with terrainOverlayOpacity alpha
       - Coordinate labels (q,r) always render at full opacity regardless of terrain overlay setting

    5. **Rendering order verification** — Confirm the viewport child order is:
       ImageLayer → TerrainLayer → GridLineLayer → HighlightLayer → FogLayer → TokenLayer → UIOverlayLayer
       Fog must render ON TOP of image layers so unrevealed hexes hide the image for players.

    6. **Map data loading** — When a session starts or map data loads, fetch the campaign's maps and current map's layers via GET endpoints. Populate useImageLayerStore with layers.
  </action>
  <verify>
    Run `pnpm --filter @hex-crawl/server tsc --noEmit` and `pnpm --filter @hex-crawl/client tsc --noEmit` pass.
    Open two browser tabs (DM + player). DM uploads image → player sees it appear. DM toggles playerVisible off → player's layer disappears. DM adjusts grid style → grid lines change color/thickness.
  </verify>
  <done>Layer changes broadcast in real time. Players see only playerVisible layers. Grid lines use configurable color/thickness/opacity. Terrain overlay opacity is adjustable. Fog renders on top of images.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete map image upload feature: DM can upload map images, manage layers, align grid, and all changes sync to players in real time. Grid renders as configurable wireframe over images. Fog of war covers images for players.</what-built>
  <how-to-verify>
    1. Open app as DM. Go to a campaign session.
    2. In SidePanel, click "Images" tab.
    3. Upload a PNG/JPG map image. Verify it appears as background beneath the hex grid.
    4. Verify hex grid renders as wireframe (line outlines only) over the image.
    5. Click "Align" on the layer. Verify alignment controls appear and hex interaction is disabled.
    6. Adjust grid offset and hex size values. Verify grid moves relative to image.
    7. Adjust grid line color/thickness. Verify grid appearance changes.
    8. Click "Done" to exit alignment mode. Verify hex interaction resumes.
    9. Toggle terrain overlay on. Verify semi-transparent terrain colors appear over image.
    10. Upload a second image. Drag to reorder layers. Verify order changes.
    11. Toggle playerVisible off on one layer.
    12. Open a second browser tab as a player in the same session.
    13. Verify player sees only playerVisible layers, grid, and fog.
    14. As DM, reveal some hexes. Verify fog lifts on player view, showing image beneath.
    15. As DM, delete a layer. Verify it disappears for both DM and player.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles for both server and client
2. WS messages broadcast layer changes to connected clients
3. Player role filtering works (playerVisible enforcement)
4. Grid lines render with configurable color/thickness/opacity
5. Terrain overlay opacity is adjustable
6. Fog of war renders on top of image layers
7. Coordinate labels always visible
8. End-to-end: upload → render → align → sync → fog works
</verification>

<success_criteria>
DM can upload map images, manage layers, align the grid, configure grid appearance, and all changes sync in real time to players with correct fog of war coverage and role-based visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/06-map-image-upload/06-04-SUMMARY.md`
</output>
