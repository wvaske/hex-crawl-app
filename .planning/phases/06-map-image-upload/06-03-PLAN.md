---
phase: 06-map-image-upload
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - packages/client/src/components/ImageLayerPanel.tsx
  - packages/client/src/components/AlignmentControls.tsx
  - packages/client/src/components/SidePanel.tsx
  - packages/client/src/canvas/HexInteraction.tsx
autonomous: true

must_haves:
  truths:
    - "DM can upload an image via the side panel and it appears as background"
    - "DM can see a list of image layers with drag-to-reorder and visibility toggles"
    - "DM can enter alignment mode and adjust grid offset/hex size with numeric inputs"
    - "Alignment mode disables hex interaction and viewport drag"
    - "DM can delete an image layer from the list"
    - "Per-layer player visibility toggle controls what players see"
  artifacts:
    - path: "packages/client/src/components/ImageLayerPanel.tsx"
      provides: "Layer list with upload button, reorder, visibility, delete"
    - path: "packages/client/src/components/AlignmentControls.tsx"
      provides: "Grid alignment UI with offset/scale numeric inputs"
  key_links:
    - from: "packages/client/src/components/ImageLayerPanel.tsx"
      to: "packages/server/src/routes/map-images.ts"
      via: "fetch POST/GET/DELETE for image upload/list/delete"
    - from: "packages/client/src/components/AlignmentControls.tsx"
      to: "packages/client/src/stores/useImageLayerStore.ts"
      via: "enterAlignmentMode/exitAlignmentMode actions"
    - from: "packages/client/src/canvas/HexInteraction.tsx"
      to: "packages/client/src/stores/useImageLayerStore.ts"
      via: "alignmentMode check to disable hex interaction"
---

<objective>
Build the DM-facing UI for image layer management and grid alignment: upload button, layer list with reorder/visibility/delete, and alignment mode with offset/scale controls.

Purpose: Gives the DM full control over map image layers and grid alignment to uploaded images.
Output: ImageLayerPanel in SidePanel, AlignmentControls overlay, alignment mode integration.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-map-image-upload/06-RESEARCH.md
@.planning/phases/06-map-image-upload/06-CONTEXT.md
@.planning/phases/06-map-image-upload/06-01-SUMMARY.md
@.planning/phases/06-map-image-upload/06-02-SUMMARY.md
@packages/client/src/components/SidePanel.tsx
@packages/client/src/components/FogControls.tsx
@packages/client/src/canvas/HexInteraction.tsx
@packages/client/src/stores/useImageLayerStore.ts
@packages/client/src/stores/useUIStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ImageLayerPanel component</name>
  <files>
    packages/client/src/components/ImageLayerPanel.tsx
    packages/client/src/components/SidePanel.tsx
  </files>
  <action>
    1. Create `ImageLayerPanel.tsx` — DM-only component shown in SidePanel (new tab or section):
       - **Upload button**: file input accepting image/png, image/jpeg. On file select, POST to `/api/campaigns/{id}/maps/{mapId}/images` as FormData with field name "image". On success, add layer to store.
       - **Layer list**: render layers from useImageLayerStore sorted by sortOrder. Each layer row shows:
         - Thumbnail or filename
         - Visibility toggle (eye icon or checkbox) — calls PATCH to update `visible`
         - Player visibility toggle (player icon) — calls PATCH to update `playerVisible`
         - "Align" button — enters alignment mode for this layer (calls enterAlignmentMode)
         - Delete button — calls DELETE endpoint, removes from store
       - **Drag-to-reorder**: use HTML drag-and-drop API (dragstart/dragover/drop) on list items. On drop, compute new sortOrder values and PATCH each changed layer. Update store via reorderLayers.
       - **Fetch on mount**: GET layers from server and call setLayers on store.

    2. Add ImageLayerPanel to SidePanel.tsx:
       - Add a new "Images" tab (or add to existing tab structure)
       - Only visible when user is DM
       - Show ImageLayerPanel content in that tab

    Style with Tailwind following existing dark theme (bg-gray-800, text-gray-100, etc). Match FogControls.tsx patterns for DM-only controls.
  </action>
  <verify>Run `pnpm --filter @hex-crawl/client tsc --noEmit` passes. Start dev server, open as DM, verify Images tab appears in SidePanel. Upload button visible.</verify>
  <done>DM sees Images tab in SidePanel with upload button and layer list. Upload, reorder, visibility toggle, and delete all functional.</done>
</task>

<task type="auto">
  <name>Task 2: AlignmentControls + alignment mode integration</name>
  <files>
    packages/client/src/components/AlignmentControls.tsx
    packages/client/src/canvas/HexInteraction.tsx
  </files>
  <action>
    1. Create `AlignmentControls.tsx` — overlay panel shown when alignmentMode is true:
       - Appears as a floating panel over the canvas (absolute positioned, z-index above SidePanel)
       - Shows current grid settings: gridOffsetX, gridOffsetY, hexSizeX, hexSizeY
       - Numeric input fields for each value with step controls (fine-tuning)
       - On value change, PATCH the map endpoint to update grid settings and update local state
       - "Done" button calls exitAlignmentMode() and saves final values to server
       - Visual: distinct background (e.g., semi-transparent dark overlay border) so DM knows they're in alignment mode
       - Grid line style controls: color picker for gridLineColor, slider for gridLineThickness, slider for gridLineOpacity
       - Terrain overlay toggle + opacity slider (terrainOverlayEnabled, terrainOverlayOpacity)

    2. Edit `HexInteraction.tsx` (or equivalent pointer event handler):
       - Import useImageLayerStore
       - At the top of pointer event handlers, check `useImageLayerStore.getState().alignmentMode`
       - If true, return early (skip all hex interaction — no hover, select, paint, drag)
       - Also disable viewport drag plugin when alignment mode is active (pause viewport.drag)

    Mount AlignmentControls in MapView or App so it renders when alignmentMode is true.

    Style with Tailwind dark theme. Numeric inputs should be compact (w-20) with labels.
  </action>
  <verify>Run `pnpm --filter @hex-crawl/client tsc --noEmit` passes. Click "Align" on a layer, verify alignment panel appears, hex interaction is disabled, numeric inputs change grid position.</verify>
  <done>Alignment mode activates from layer panel. Controls visible for offset/scale/grid style. Hex interaction disabled during alignment. "Done" exits mode and saves.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @hex-crawl/client tsc --noEmit` passes
2. Images tab visible in SidePanel for DM
3. Upload button triggers file upload and layer appears
4. Layer list shows reorder, visibility, delete controls
5. Alignment mode disables hex interaction
6. Grid offset/scale inputs update the grid position
</verification>

<success_criteria>
DM can upload images, manage layers (reorder, visibility, delete), and enter alignment mode to adjust grid positioning over the uploaded image.
</success_criteria>

<output>
After completion, create `.planning/phases/06-map-image-upload/06-03-SUMMARY.md`
</output>
