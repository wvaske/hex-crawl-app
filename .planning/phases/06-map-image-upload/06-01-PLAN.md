---
phase: 06-map-image-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/schema/map.ts
  - packages/server/src/db/schema/map-image-layer.ts
  - packages/server/src/db/schema/index.ts
  - packages/server/src/storage/interface.ts
  - packages/server/src/storage/local.ts
  - packages/server/src/routes/map-images.ts
  - packages/server/src/app.ts
  - packages/shared/src/ws-messages.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "campaign_map and map_image_layer tables exist in database after migration"
    - "POST upload endpoint accepts multipart image and stores file on disk"
    - "GET endpoint returns image layer metadata for a map"
    - "DELETE endpoint removes image layer and its file from disk"
    - "Uploaded files are served via /uploads/* static route"
  artifacts:
    - path: "packages/server/src/db/schema/map.ts"
      provides: "campaign_map table with grid style settings"
      contains: "campaignMap"
    - path: "packages/server/src/db/schema/map-image-layer.ts"
      provides: "map_image_layer table with per-layer alignment"
      contains: "mapImageLayer"
    - path: "packages/server/src/storage/interface.ts"
      provides: "StorageBackend interface"
      exports: ["StorageBackend"]
    - path: "packages/server/src/storage/local.ts"
      provides: "LocalStorageBackend implementation"
      exports: ["LocalStorageBackend"]
    - path: "packages/server/src/routes/map-images.ts"
      provides: "Image upload/list/update/delete routes"
  key_links:
    - from: "packages/server/src/routes/map-images.ts"
      to: "packages/server/src/storage/local.ts"
      via: "storage.put/delete calls"
    - from: "packages/server/src/routes/map-images.ts"
      to: "packages/server/src/db/schema/map-image-layer.ts"
      via: "db.insert/select/delete on mapImageLayer"
    - from: "packages/server/src/app.ts"
      to: "packages/server/src/routes/map-images.ts"
      via: "app.route() mount"
---

<objective>
Create the server-side foundation for map image upload: database schema (campaign_map, map_image_layer), storage abstraction (local filesystem), file upload/serve routes, and shared WS message types for layer sync.

Purpose: Enables the DM to upload, list, update, and delete map image layers with persistent storage and metadata.
Output: DB tables, storage backend, REST endpoints, shared message types.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-map-image-upload/06-RESEARCH.md
@.planning/phases/06-map-image-upload/06-CONTEXT.md
@packages/server/src/db/schema/index.ts
@packages/server/src/db/schema/campaign.ts
@packages/server/src/db/schema/token.ts
@packages/server/src/routes/map.ts
@packages/server/src/app.ts
@packages/shared/src/ws-messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema + storage abstraction</name>
  <files>
    packages/server/src/db/schema/map.ts
    packages/server/src/db/schema/map-image-layer.ts
    packages/server/src/db/schema/index.ts
    packages/server/src/storage/interface.ts
    packages/server/src/storage/local.ts
  </files>
  <action>
    1. Create `packages/server/src/db/schema/map.ts` with `campaignMap` table:
       - id: text PK (crypto.randomUUID)
       - campaignId: text FK to campaign.id (onDelete cascade)
       - name: text not null
       - sortOrder: integer default 0
       - gridLineColor: text default "#ffffff"
       - gridLineThickness: real default 1.0
       - gridLineOpacity: real default 0.4
       - terrainOverlayEnabled: boolean default false
       - terrainOverlayOpacity: real default 0.3
       - gridOffsetX: real default 0
       - gridOffsetY: real default 0
       - hexSizeX: real default 40 (independent H scale)
       - hexSizeY: real default 40 (independent V scale)
       - createdAt: timestamp defaultNow

    2. Create `packages/server/src/db/schema/map-image-layer.ts` with `mapImageLayer` table:
       - id: text PK
       - mapId: text FK to campaignMap.id (onDelete cascade)
       - fileName: text not null (original upload name)
       - storageKey: text not null (path in storage)
       - contentType: text not null
       - fileSize: integer not null
       - offsetX, offsetY: real default 0
       - scaleX, scaleY: real default 1.0
       - sortOrder: integer default 0
       - visible: boolean default true
       - playerVisible: boolean default true
       - createdAt: timestamp defaultNow

    3. Export both from `packages/server/src/db/schema/index.ts` (add `export * from "./map"` and `export * from "./map-image-layer"`)

    4. Create `packages/server/src/storage/interface.ts`:
       ```typescript
       export interface StorageBackend {
         put(key: string, data: Buffer, contentType: string): Promise<void>;
         getUrl(key: string): string;
         delete(key: string): Promise<void>;
       }
       ```

    5. Create `packages/server/src/storage/local.ts` implementing LocalStorageBackend:
       - Constructor takes basePath (e.g., "./uploads") and urlPrefix (e.g., "/uploads")
       - put: mkdir -p dirname, writeFile
       - getUrl: return `${urlPrefix}/${key}`
       - delete: unlink with catch for missing files

    6. Run `pnpm --filter @hex-crawl/server drizzle-kit push` to create tables.

    Follow the exact Drizzle schema patterns from existing files (campaign.ts, token.ts). Use pgTable, text, integer, real, boolean, timestamp from drizzle-orm/pg-core. Use extensionless imports for schema cross-references.
  </action>
  <verify>
    Run `pnpm --filter @hex-crawl/server drizzle-kit push` succeeds. Verify tables exist by checking drizzle-kit output. Run `pnpm --filter @hex-crawl/server tsc --noEmit` passes.
  </verify>
  <done>campaign_map and map_image_layer tables exist in DB. StorageBackend interface and LocalStorageBackend implementation compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Upload routes + static serving + WS message types</name>
  <files>
    packages/server/src/routes/map-images.ts
    packages/server/src/app.ts
    packages/shared/src/ws-messages.ts
    packages/shared/src/index.ts
  </files>
  <action>
    1. Create `packages/server/src/routes/map-images.ts` as a Hono router with these endpoints:
       - **POST /api/campaigns/:campaignId/maps** — Create a new campaign_map. Copy grid style settings from most recent map in campaign (if any) for inheritance. Return the map object.
       - **GET /api/campaigns/:campaignId/maps** — List all maps for a campaign (sorted by sortOrder).
       - **POST /api/campaigns/:campaignId/maps/:mapId/images** — Upload image. Use `c.req.parseBody()`, validate file is File instance, validate extension (png/jpg/jpeg). Generate storage key as `maps/{mapId}/{uuid}.{ext}`. Call storage.put(). Insert map_image_layer row with next sortOrder. Return layer metadata with URL.
       - **GET /api/campaigns/:campaignId/maps/:mapId/images** — List image layers for a map (sorted by sortOrder). Filter by playerVisible based on user role (check campaign membership for isDM).
       - **PATCH /api/campaigns/:campaignId/maps/:mapId/images/:layerId** — Update layer properties (offsetX/Y, scaleX/Y, sortOrder, visible, playerVisible). Return updated layer.
       - **DELETE /api/campaigns/:campaignId/maps/:mapId/images/:layerId** — Delete layer: call storage.delete(storageKey), delete DB row. Return 204.
       - **PATCH /api/campaigns/:campaignId/maps/:mapId** — Update map properties (name, grid style settings, gridOffsetX/Y, hexSizeX/Y). Return updated map.

       All routes require auth (use the existing requireAuth / auth middleware pattern from campaigns.ts). Verify campaign membership. DM-only for write operations.

       Instantiate LocalStorageBackend with basePath="./uploads" and urlPrefix="/uploads" at module level (or pass via Hono variables).

    2. Mount routes in `packages/server/src/app.ts`:
       - Add `serveStatic` from `@hono/node-server/serve-static` for `/uploads/*` path
       - Mount the map-images router

    3. Add WS message types to `packages/shared/src/ws-messages.ts`:
       - `layer:added` — server->client, contains full layer object
       - `layer:updated` — server->client, contains layerId + partial updates
       - `layer:removed` — server->client, contains layerId
       - `map:updated` — server->client, contains mapId + partial map updates (grid settings)
       Add these to the ServerMessage union type.

    4. Export any new shared types from `packages/shared/src/index.ts` if needed.

    Follow existing route patterns: Hono<any> type, c.get("user") for auth, db queries with Drizzle eq/and operators.
  </action>
  <verify>
    Run `pnpm --filter @hex-crawl/server tsc --noEmit` and `pnpm --filter @hex-crawl/shared tsc --noEmit` both pass. Start the server and test with curl:
    - Create a map: `curl -X POST http://localhost:3000/api/campaigns/{id}/maps -H "Cookie: ..." -H "Content-Type: application/json" -d '{"name":"Test Map"}'`
    - Upload an image: `curl -X POST http://localhost:3000/api/campaigns/{id}/maps/{mapId}/images -H "Cookie: ..." -F "image=@test.png"`
    - List layers: `curl http://localhost:3000/api/campaigns/{id}/maps/{mapId}/images -H "Cookie: ..."`
    - Verify uploaded file accessible at the returned URL
  </verify>
  <done>All CRUD endpoints work. File upload stores to disk and returns accessible URL. WS message types compile. serveStatic serves uploaded files.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @hex-crawl/server tsc --noEmit` passes
2. `pnpm --filter @hex-crawl/shared tsc --noEmit` passes
3. Database tables created (drizzle-kit push succeeds)
4. File upload stores file on disk under ./uploads/
5. Uploaded file is accessible via HTTP at /uploads/...
6. Layer CRUD operations work via REST API
</verification>

<success_criteria>
Server can accept image uploads, store them on local disk, persist metadata in PostgreSQL, serve uploaded files via HTTP, and has shared WS message types ready for real-time sync.
</success_criteria>

<output>
After completion, create `.planning/phases/06-map-image-upload/06-01-SUMMARY.md`
</output>
