---
phase: 04-fog-of-war
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/client/src/canvas/layers/FogLayer.tsx
  - packages/client/src/stores/useSessionStore.ts
  - packages/client/src/components/MapView.tsx
autonomous: true

must_haves:
  truths:
    - "Unrevealed hexes show a dark opaque overlay (tier 2) that hides all terrain detail"
    - "Hexes adjacent to revealed hexes show a semi-transparent overlay (tier 1) with dimmed terrain visible"
    - "Revealed hexes have no fog overlay"
    - "DM sees full terrain with a subtle tint on unrevealed hexes (not opaque fog)"
    - "Fog layer updates reactively when revealedHexKeys or adjacentHexKeys change in the store"
  artifacts:
    - path: "packages/client/src/canvas/layers/FogLayer.tsx"
      provides: "Two-tier fog overlay rendering using Graphics, following HighlightLayer pattern"
      contains: "FogLayer"
    - path: "packages/client/src/stores/useSessionStore.ts"
      provides: "adjacentHexKeys Set and hex:hidden dispatch handler"
      contains: "adjacentHexKeys"
    - path: "packages/client/src/components/MapView.tsx"
      provides: "FogLayer mounted between GridLineLayer and HighlightLayer"
      contains: "FogLayer"
  key_links:
    - from: "packages/client/src/canvas/layers/FogLayer.tsx"
      to: "packages/client/src/stores/useSessionStore.ts"
      via: "useSessionStore selectors for revealedHexKeys, adjacentHexKeys, userRole"
      pattern: "useSessionStore"
    - from: "packages/client/src/components/MapView.tsx"
      to: "packages/client/src/canvas/layers/FogLayer.tsx"
      via: "JSX child in HexMapCanvas"
      pattern: "<FogLayer"
---

<objective>
Render two-tier fog of war overlays on the hex map canvas. Players see opaque fog on unrevealed hexes (tier 2), dimmed terrain on adjacent hexes (tier 1), and clear terrain on revealed hexes. DM sees a subtle tint on unrevealed hexes. Fog updates reactively via Zustand store.

Purpose: This is the visual heart of fog of war — players must not see any terrain detail through the fog. The rendering must be performant (viewport culling) and reactive (updates when reveals happen).

Output: FogLayer component, extended session store with adjacentHexKeys and hex:hidden handling, FogLayer integrated into MapView.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-fog-of-war/04-01-SUMMARY.md
@packages/client/src/canvas/layers/HighlightLayer.tsx
@packages/client/src/canvas/layers/TerrainLayer.tsx
@packages/client/src/stores/useSessionStore.ts
@packages/client/src/stores/useMapStore.ts
@packages/client/src/components/MapView.tsx
@packages/client/src/hex/grid.ts
@packages/shared/src/ws-messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend session store with adjacentHexKeys and hex:hidden dispatch</name>
  <files>packages/client/src/stores/useSessionStore.ts</files>
  <action>
    1. Add `adjacentHexKeys: Set<string>` to SessionState interface, initialized as `new Set()` in initialState.

    2. In the `dispatch` function, update existing cases and add new ones:
       - `session:state`: If message has `adjacentHexes` array, build `new Set(message.adjacentHexes.map(h => h.key))` and set as `adjacentHexKeys`. Always new Set (PITFALL 6).
       - `hex:revealed`: Also update adjacentHexKeys if message includes `adjacentHexes`. Compute: for each new adjacent hex, add to adjacentHexKeys; remove any hex from adjacentHexKeys that is now in revealedHexKeys.
       - Add case `hex:hidden`: Create new Set from existing revealedHexKeys, remove all hexKeys in message. Set `revealedHexKeys` to the new Set. Also recompute adjacentHexKeys by removing any adjacent keys that are no longer adjacent to any revealed hex (or simply clear adjacentHexKeys and let the next session:state or hex:revealed repopulate — simpler approach).

    3. Ensure the `reset` action resets adjacentHexKeys to `new Set()`.
  </action>
  <verify>
    `cd packages/client && pnpm tsc --noEmit` compiles. Store correctly handles hex:hidden by removing keys from revealedHexKeys.
  </verify>
  <done>Session store tracks adjacentHexKeys, handles hex:hidden, and updates adjacency on reveals.</done>
</task>

<task type="auto">
  <name>Task 2: Create FogLayer component and integrate into MapView</name>
  <files>
    packages/client/src/canvas/layers/FogLayer.tsx
    packages/client/src/components/MapView.tsx
  </files>
  <action>
    1. Create `packages/client/src/canvas/layers/FogLayer.tsx` following HighlightLayer pattern exactly:
       - Import useTick from @pixi/react, Container/Graphics from pixi.js, useRef/useEffect/useCallback from react.
       - Import parseHexKey from @hex-crawl/shared, createGrid/GameHex from ../../hex/grid.
       - Import useSessionStore and useMapStore.
       - Constants:
         - TIER2_FILL = 0x1a1a2e, TIER2_ALPHA = 0.95 (deep fog — nearly opaque dark)
         - TIER1_FILL = 0x2a2a3e, TIER1_ALPHA = 0.55 (adjacent — dimmed but terrain visible underneath)
         - DM_TINT_FILL = 0xff4444, DM_TINT_ALPHA = 0.08 (subtle red tint for unrevealed on DM view)
       - Component `FogLayer`:
         - containerRef, graphicsRef, gridRef pattern (same as HighlightLayer).
         - Subscribe to: revealedHexKeys, adjacentHexKeys, userRole from useSessionStore. gridWidth, gridHeight, hexes from useMapStore.
         - Refs for tick callback (same pattern as HighlightLayer hoveredHexRef/selectedHexesRef).
         - Change detection: track last-drawn revealedHexKeys size + adjacentHexKeys size + a reference hash. Only redraw when changed.
         - `drawFog` callback (called via useTick):
           a. Clear graphics.
           b. Build hexLookup from grid (same as HighlightLayer).
           c. Get all hex keys from useMapStore hexes.
           d. If userRole === 'dm':
              - For each hex key NOT in revealedHexKeys, draw hex polygon with DM_TINT (subtle red overlay so DM knows what's hidden from players).
           e. If userRole === 'player' or null:
              - For each hex key in allHexKeys:
                - If in revealedHexKeys → skip (no fog).
                - If in adjacentHexKeys → draw with TIER1_FILL/TIER1_ALPHA.
                - Else → draw with TIER2_FILL/TIER2_ALPHA.
           f. Use `drawHexPolygon` helper (extract from HighlightLayer's drawHexHighlight or inline): moveTo first corner, lineTo remaining corners, fill with color+alpha. No stroke needed for fog.
         - Viewport culling: get viewport bounds from the module-level viewport ref (ViewportContext.tsx). Only draw fog for hexes whose pixel position falls within viewport bounds + padding. Same culling pattern as TerrainLayer.

    2. In `packages/client/src/components/MapView.tsx`:
       - Import FogLayer from '../canvas/layers/FogLayer'.
       - Add `<FogLayer />` between `<GridLineLayer />` and `<HighlightLayer />` in the HexMapCanvas children. This places fog at z-index ~1.5 (above terrain/grid, below highlights).

    3. Verify client compiles: `cd packages/client && pnpm tsc --noEmit`.
  </action>
  <verify>
    `cd packages/client && pnpm tsc --noEmit` compiles. Open the app in browser — fog layer renders on the canvas. All hexes should show tier-2 fog by default (no hexes revealed yet). DM view shows subtle red tint instead.
  </verify>
  <done>FogLayer renders two-tier fog overlays. Players see opaque fog on unrevealed hexes. DM sees subtle tint. Fog updates reactively when store changes. Viewport culling prevents rendering off-screen hexes.</done>
</task>

</tasks>

<verification>
1. `cd packages/client && pnpm tsc --noEmit` — passes
2. Open app as player — all hexes show dark opaque overlay (no terrain visible)
3. Open app as DM — all hexes show terrain with subtle red tint on unrevealed
4. When revealedHexKeys changes in store, fog overlay updates (hex becomes clear)
5. Adjacent hexes show dimmed/semi-transparent overlay
6. No frame rate drop with 500+ fogged hexes (viewport culling active)
</verification>

<success_criteria>
- FogLayer component renders and is positioned between grid lines and highlights
- Players cannot see terrain detail through tier-2 fog
- Adjacent tier-1 hexes show dimmed terrain
- DM sees all terrain with tint indicator
- Fog updates reactively when Zustand store changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-fog-of-war/04-03-SUMMARY.md`
</output>
