---
phase: 04-fog-of-war
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - packages/client/src/components/FogControls.tsx
  - packages/client/src/components/SidePanel.tsx
  - packages/client/src/components/MapView.tsx
  - packages/client/src/stores/useUIStore.ts
  - packages/client/src/hooks/useFogActions.ts
autonomous: false

must_haves:
  truths:
    - "DM can select hexes and click Reveal to reveal them to all players"
    - "DM can select hexes and click Hide to hide them from players"
    - "Reveal All and Hide All require typing REVEAL ALL or HIDE ALL to confirm"
    - "Players do not see fog control buttons"
    - "When DM reveals a hex, all connected players see fog lift within 1 second"
    - "Fog state persists — revealed hexes remain revealed after browser close/reopen"
    - "DM can save map data to server so fog enforcement works on reconnect"
  artifacts:
    - path: "packages/client/src/components/FogControls.tsx"
      provides: "Reveal/Hide selected buttons, Reveal All/Hide All with confirmation, player target selector"
      contains: "FogControls"
    - path: "packages/client/src/hooks/useFogActions.ts"
      provides: "Hook encapsulating reveal/hide WS message sending and map upload"
      contains: "useFogActions"
    - path: "packages/client/src/components/SidePanel.tsx"
      provides: "Fog tab added for DM users"
      contains: "FogControls"
  key_links:
    - from: "packages/client/src/components/FogControls.tsx"
      to: "packages/client/src/stores/useSessionStore.ts"
      via: "sendMessage for hex:reveal/hex:hide"
      pattern: "sendMessage"
    - from: "packages/client/src/hooks/useFogActions.ts"
      to: "packages/server/src/routes/map.ts"
      via: "fetch POST /api/campaigns/:id/map"
      pattern: "api/campaigns.*map"
---

<objective>
Build the DM-facing fog controls: Reveal/Hide buttons for selected hexes, Reveal All/Hide All with distinct confirmation (type to confirm), player targeting, and map data upload to server. Wire everything end-to-end and verify the full fog of war flow.

Purpose: This completes the fog of war feature. DM can control visibility, reveals propagate in real time, and the full pipeline works: DM reveals → server persists + broadcasts → players see fog lift.

Output: FogControls UI component, useFogActions hook, SidePanel fog tab, end-to-end fog of war working.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-fog-of-war/04-01-SUMMARY.md
@.planning/phases/04-fog-of-war/04-02-SUMMARY.md
@.planning/phases/04-fog-of-war/04-03-SUMMARY.md
@packages/client/src/components/SidePanel.tsx
@packages/client/src/components/MapView.tsx
@packages/client/src/stores/useUIStore.ts
@packages/client/src/stores/useSessionStore.ts
@packages/client/src/stores/useMapStore.ts
@packages/shared/src/ws-messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fog actions hook, FogControls component, and wire into SidePanel</name>
  <files>
    packages/client/src/hooks/useFogActions.ts
    packages/client/src/components/FogControls.tsx
    packages/client/src/components/SidePanel.tsx
    packages/client/src/stores/useUIStore.ts
  </files>
  <action>
    1. Create `packages/client/src/hooks/useFogActions.ts`:
       - `useFogActions(campaignId: string)` hook returning:
         - `revealSelected(hexKeys: string[], targets?: "all" | { playerIds: string[] })` — sends hex:reveal WS message via sendMessage from useSessionStore.
         - `hideSelected(hexKeys: string[], targets?: "all" | { playerIds: string[] })` — sends hex:hide WS message.
         - `revealAll()` — sends hex:reveal with ALL hex keys from useMapStore.hexes.
         - `hideAll()` — sends hex:hide with ALL currently revealed hex keys from useSessionStore.revealedHexKeys.
         - `uploadMapToServer()` — POST to `/api/campaigns/${campaignId}/map` with all hex data from useMapStore. Called when DM saves/creates a map so server has data for fog enforcement.

    2. Create `packages/client/src/components/FogControls.tsx`:
       - Only renders when userRole === 'dm' (from useSessionStore).
       - Sections:
         a. **Selected Hex Actions:** "Reveal Selected" and "Hide Selected" buttons. Disabled when no hexes selected (from useUIStore.selectedHexes). Show count: "Reveal 5 hexes" / "Hide 5 hexes".
         b. **Target Selector:** Default "All Players" radio. Optional "Specific Players" radio that shows checkbox list of connectedPlayers (from useSessionStore). When specific is chosen, only checked player IDs are sent as targets.
         c. **Bulk Actions:** "Reveal All Hexes" and "Hide All Hexes" buttons. Each opens an inline confirmation where user must type "REVEAL ALL" or "HIDE ALL" exactly (case-insensitive) into a text input and press Confirm. This is the DISTINCT confirmation required by CONTEXT.md — NOT a browser confirm dialog, NOT the standard modal used elsewhere. Style: red/orange warning text, text input with placeholder showing what to type, Confirm button only enabled when text matches.
         d. **Map Sync:** "Save Map to Server" button that calls uploadMapToServer(). Show success/error feedback. This ensures server has terrain data for fog enforcement. Should be called automatically when DM creates a new map or modifies terrain (add a useEffect or call in CreationDialog).
       - Styling: Tailwind dark theme consistent with existing SidePanel content. Buttons: bg-blue-600 hover:bg-blue-700 for reveal, bg-red-600 hover:bg-red-700 for hide. Disabled: opacity-50 cursor-not-allowed.

    3. Update `packages/client/src/components/SidePanel.tsx`:
       - Add a new "Fog" tab to the TABS array (id: 'fog', label: 'Fog'). Only show this tab when userRole === 'dm' from useSessionStore.
       - Render `<FogControls />` when activeTab === 'fog'.
       - Import FogControls component.

    4. Update `packages/client/src/stores/useUIStore.ts`:
       - Add 'fog' to the SidePanelTab type union.

    5. Wire map upload: In CreationDialog (or wherever maps are created), after map generation completes, call the map upload endpoint to persist hex data to server. Import useFogActions or make a direct fetch call. This ensures the server always has current map data.
  </action>
  <verify>
    `cd packages/client && pnpm tsc --noEmit` compiles. Open app as DM — Fog tab visible in SidePanel. Select hexes, Reveal/Hide buttons work. Bulk actions show type-to-confirm dialog. Map uploads to server.
  </verify>
  <done>DM has full fog controls: reveal/hide selected, bulk actions with type-to-confirm, player targeting, map sync. Players don't see fog tab.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete fog of war system:
    1. DB persistence for fog state (hex_visibility) and map data (campaign_hex)
    2. Server-side fog enforcement — players only receive terrain for revealed + adjacent hexes
    3. Two-tier fog rendering: opaque (tier 2) and dimmed (tier 1) on player view, subtle tint on DM view
    4. DM fog controls: reveal/hide selected hexes, bulk actions with type-to-confirm, player targeting
    5. Real-time propagation: DM reveals → server persists + broadcasts → all players see fog lift
  </what-built>
  <how-to-verify>
    **Setup:** Open two browser windows. Log in as DM in one, player in another. Both join the same campaign.

    1. **DM creates map:** In DM window, create a new hex map (Create tab). Verify "Save Map to Server" works (check for success feedback).

    2. **Player sees full fog:** In player window, enter the map. ALL hexes should show opaque dark fog — no terrain visible at all.

    3. **DM reveals hexes:** DM selects a few hexes (click/shift-drag), switches to Fog tab, clicks "Reveal Selected". Player should see those hexes clear instantly (within 1 second). Adjacent hexes should show dimmed terrain (tier 1).

    4. **DM hides hexes:** DM selects a previously revealed hex, clicks "Hide Selected". Player should see fog return to that hex.

    5. **Persistence test:** Close player browser and reopen. Navigate to same campaign/map. Previously revealed hexes should STILL be revealed (fog state persists).

    6. **FOG-05 verification:** In player browser, open DevTools Network tab. Filter for WebSocket frames. Inspect the session:state message. Verify it does NOT contain terrain data for unrevealed hexes. Only revealed hex keys and adjacent terrain should be present.

    7. **Bulk actions:** DM clicks "Reveal All Hexes" — type-to-confirm dialog appears. Type "REVEAL ALL" and confirm. All hexes revealed for player. Then "Hide All Hexes" — type "HIDE ALL" — all hexes hidden again.

    8. **DM view:** DM should see ALL terrain clearly with a subtle red/pink tint on hexes that are hidden from players. No opaque fog on DM view.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes in all packages
2. DM can reveal/hide hexes and changes propagate to players in real time
3. Player sees two-tier fog: opaque on distant, dimmed on adjacent, clear on revealed
4. DM sees full terrain with tint overlay on unrevealed hexes
5. Fog persists across browser close/reopen (DB-backed)
6. Network inspection shows no unrevealed terrain in player WS messages (FOG-05)
7. Bulk Reveal All / Hide All requires typing confirmation text
8. Players do not see fog control buttons
</verification>

<success_criteria>
- All 5 phase success criteria from ROADMAP.md are met:
  1. DM can click hex to reveal or hide
  2. Players see opaque overlay on unrevealed hexes
  3. Reveals propagate to all players within 1 second
  4. Fog persists across sessions
  5. Server never sends unrevealed hex content to players
</success_criteria>

<output>
After completion, create `.planning/phases/04-fog-of-war/04-04-SUMMARY.md`
</output>
