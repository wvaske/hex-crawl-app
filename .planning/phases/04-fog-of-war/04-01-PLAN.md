---
phase: 04-fog-of-war
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/schema/fog.ts
  - packages/server/src/db/schema/hex-data.ts
  - packages/server/src/db/schema/index.ts
  - packages/shared/src/ws-messages.ts
  - packages/shared/src/hex-types.ts
  - packages/shared/src/index.ts
  - packages/server/src/routes/map.ts
  - packages/server/src/app.ts
autonomous: true

must_haves:
  truths:
    - "hex_visibility and campaign_hex tables exist in PostgreSQL after migration"
    - "DM client can POST map hex data to server and GET it back"
    - "WS message schemas include hex:hide (client) and hex:hidden (server) message types"
    - "Shared types include FogTier enum and adjacentHexes in session:state"
  artifacts:
    - path: "packages/server/src/db/schema/fog.ts"
      provides: "hex_visibility Drizzle table with campaign_id, hex_key, user_id (nullable), revealed_by, revealed_at"
      contains: "hexVisibility"
    - path: "packages/server/src/db/schema/hex-data.ts"
      provides: "campaign_hex Drizzle table for server-side map data storage"
      contains: "campaignHex"
    - path: "packages/shared/src/ws-messages.ts"
      provides: "hex:hide client message, hex:hidden server message, adjacentHexes in session:state"
      contains: "hex:hide"
    - path: "packages/server/src/routes/map.ts"
      provides: "POST/GET /api/campaigns/:id/map endpoints for hex data persistence"
      exports: ["mapRoutes"]
  key_links:
    - from: "packages/server/src/db/schema/fog.ts"
      to: "packages/server/src/db/schema/index.ts"
      via: "barrel export"
      pattern: "export.*fog"
    - from: "packages/server/src/routes/map.ts"
      to: "packages/server/src/app.ts"
      via: "route mount"
      pattern: "mapRoutes"
---

<objective>
Create the database foundation and WS message contracts for fog of war: hex_visibility table for persistent fog state, campaign_hex table so the server has map terrain data (required for FOG-05 enforcement), map CRUD endpoints, and extended WS message schemas.

Purpose: The server currently has NO hex/terrain data — maps are generated client-side only. For the server to enforce "never send unrevealed terrain to players" (FOG-05), it must store map data. This plan creates all schema and message contracts that Plans 02-04 depend on.

Output: Two new DB tables (hex_visibility, campaign_hex), map REST endpoints, extended WS message types.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/server/src/db/schema/session.ts
@packages/server/src/db/schema/campaign.ts
@packages/server/src/db/schema/auth.ts
@packages/server/src/db/schema/index.ts
@packages/shared/src/ws-messages.ts
@packages/shared/src/hex-types.ts
@packages/shared/src/index.ts
@packages/server/src/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DB schemas and run migration</name>
  <files>
    packages/server/src/db/schema/fog.ts
    packages/server/src/db/schema/hex-data.ts
    packages/server/src/db/schema/index.ts
  </files>
  <action>
    1. Create `packages/server/src/db/schema/fog.ts`:
       - `hexVisibility` table with columns: id (text PK, use crypto.randomUUID default pattern), campaign_id (text FK -> campaign.id, cascade delete), hex_key (text, not null), user_id (text, nullable, FK -> user.id, cascade delete — null means "all players"), revealed_by (text, not null, FK -> user.id), revealed_at (timestamp, defaultNow, not null).
       - Indexes: on campaign_id, on (campaign_id, user_id).
       - Unique constraint on (campaign_id, hex_key, user_id). NOTE: PostgreSQL treats NULL as distinct for unique — to prevent duplicate "all" reveals, add a partial unique index or use a sentinel value. Simplest: use sentinel string "__all__" instead of null for the "all players" case. This avoids NULL uniqueness issues.

    2. Create `packages/server/src/db/schema/hex-data.ts`:
       - `campaignHex` table: id (text PK), campaign_id (text FK -> campaign.id, cascade delete), hex_key (text, not null), terrain (text, not null), terrain_variant (integer, not null, default 0).
       - Unique constraint on (campaign_id, hex_key).
       - Index on campaign_id.

    3. Update `packages/server/src/db/schema/index.ts` to export both new schemas.

    4. Add "hex_hide" to the sessionEventTypeEnum values array in session.ts (append after "token_move").

    5. Run `pnpm drizzle-kit generate` and `pnpm drizzle-kit migrate` from packages/server to create and apply the migration.
  </action>
  <verify>
    Run `pnpm drizzle-kit generate` — should succeed with new migration file. Run `pnpm drizzle-kit migrate` — tables created. Verify with a quick DB query or drizzle-kit studio check.
  </verify>
  <done>hex_visibility and campaign_hex tables exist in PostgreSQL. hex_hide added to session_event_type enum.</done>
</task>

<task type="auto">
  <name>Task 2: Extend WS messages and shared types, add map REST endpoints</name>
  <files>
    packages/shared/src/ws-messages.ts
    packages/shared/src/hex-types.ts
    packages/shared/src/index.ts
    packages/server/src/routes/map.ts
    packages/server/src/app.ts
  </files>
  <action>
    1. In `packages/shared/src/ws-messages.ts`:
       - Add `HexHideMessage` to client messages: `{ type: "hex:hide", hexKeys: string[], targets: "all" | { playerIds: string[] } }`. Add to ClientMessageSchema discriminated union.
       - Add `HexHiddenMessage` to server messages: `{ type: "hex:hidden", hexKeys: string[] }`. Add to ServerMessageSchema discriminated union.
       - Extend `SessionStateMessage` to include `adjacentHexes: z.array(z.object({ key: z.string(), terrain: z.string() })).optional()` (optional for backward compat during rollout).
       - Extend `HexRevealedMessage` to include optional `adjacentHexes` field with same shape.

    2. In `packages/shared/src/hex-types.ts`:
       - Add `FogTier` type: `"revealed" | "adjacent" | "hidden"`.
       - Export it.

    3. In `packages/shared/src/index.ts`:
       - Export `FogTier` type from hex-types.

    4. Create `packages/server/src/routes/map.ts`:
       - Hono router with two endpoints:
       - `POST /api/campaigns/:id/map` — Accepts JSON body `{ hexes: Array<{ key: string, terrain: string, terrainVariant: number }> }`. Requires auth (use requireAuth middleware from existing auth setup). Verifies user is DM of campaign. Upserts all hex data into campaign_hex table (delete existing + insert, wrapped in transaction). Returns 200.
       - `GET /api/campaigns/:id/map` — Requires auth + campaign membership. Returns all campaign_hex rows for that campaign as `{ hexes: Array<{ key, terrain, terrainVariant }> }`.
       - Import and use existing `requireAuth` middleware pattern and `db` from existing code.

    5. In `packages/server/src/app.ts`:
       - Import and mount mapRoutes on the app (same pattern as existing campaign/invitation routes).

    6. Verify the server compiles: `cd packages/server && pnpm tsc --noEmit`.
  </action>
  <verify>
    `pnpm tsc --noEmit` passes in both shared and server packages. Test the map endpoints with curl: POST a few hexes, GET them back.
  </verify>
  <done>WS messages include hex:hide/hex:hidden, session:state includes adjacentHexes. Map CRUD endpoints work. Server compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `cd packages/shared && pnpm tsc --noEmit` — passes
2. `cd packages/server && pnpm tsc --noEmit` — passes
3. DB tables exist: hex_visibility, campaign_hex
4. `curl -X POST .../api/campaigns/{id}/map` with auth creates hex data
5. `curl -X GET .../api/campaigns/{id}/map` returns stored hex data
6. WS message types compile with new hex:hide/hex:hidden messages
</verification>

<success_criteria>
- hex_visibility and campaign_hex tables exist and can be queried
- Map data can be persisted via REST endpoint and retrieved
- WS message schemas compile and include fog-related messages
- No TypeScript compilation errors in shared or server packages
</success_criteria>

<output>
After completion, create `.planning/phases/04-fog-of-war/04-01-SUMMARY.md`
</output>
