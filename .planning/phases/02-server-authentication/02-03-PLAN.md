---
phase: 02-server-authentication
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/client/package.json
  - packages/client/src/lib/auth-client.ts
  - packages/client/src/components/auth/LoginPage.tsx
  - packages/client/src/components/auth/SignupPage.tsx
  - packages/client/src/components/auth/AuthGuard.tsx
  - packages/client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an account via a signup form in the browser"
    - "User can log in via a login form in the browser"
    - "Logged-in user stays logged in after browser refresh (session cookie persists)"
    - "Unauthenticated user sees the login page, not the app"
    - "User can log out and is redirected to the login page"
  artifacts:
    - path: "packages/client/src/lib/auth-client.ts"
      provides: "Better Auth React client with baseURL config"
      contains: "createAuthClient"
    - path: "packages/client/src/components/auth/LoginPage.tsx"
      provides: "Email/password login form"
      contains: "signIn"
    - path: "packages/client/src/components/auth/SignupPage.tsx"
      provides: "Email/password signup form"
      contains: "signUp"
    - path: "packages/client/src/components/auth/AuthGuard.tsx"
      provides: "Session-gated wrapper that shows login when unauthenticated"
      contains: "useSession"
  key_links:
    - from: "packages/client/src/lib/auth-client.ts"
      to: "http://localhost:3000/api/auth/*"
      via: "Better Auth client with baseURL"
      pattern: "baseURL"
    - from: "packages/client/src/components/auth/AuthGuard.tsx"
      to: "packages/client/src/lib/auth-client.ts"
      via: "authClient.useSession() hook"
      pattern: "useSession"
    - from: "packages/client/src/App.tsx"
      to: "packages/client/src/components/auth/AuthGuard.tsx"
      via: "AuthGuard wrapping app content"
      pattern: "AuthGuard"
---

<objective>
Integrate Better Auth's React client into the client app with login, signup, and session management so users can authenticate in the browser.

Purpose: Users need to authenticate before they can create or join campaigns. This plan adds the client-side auth flow that communicates with the server's /api/auth/* endpoints.
Output: Login and signup pages, an AuthGuard wrapper that gates the app behind authentication, and reactive session management that persists across refreshes.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-authentication/02-RESEARCH.md
@.planning/phases/02-server-authentication/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Better Auth client and create Login/Signup pages</name>
  <files>
    packages/client/package.json
    packages/client/src/lib/auth-client.ts
    packages/client/src/components/auth/LoginPage.tsx
    packages/client/src/components/auth/SignupPage.tsx
  </files>
  <action>
1. Install Better Auth in the client package:
   ```bash
   cd packages/client && pnpm add better-auth
   ```

2. Create `packages/client/src/lib/auth-client.ts`:
   ```typescript
   import { createAuthClient } from "better-auth/react";

   export const authClient = createAuthClient({
     baseURL: import.meta.env.VITE_API_URL || "http://localhost:3000",
   });
   ```
   This exports the full client object. Components use `authClient.useSession()`, `authClient.signIn.email()`, `authClient.signUp.email()`, `authClient.signOut()`.

3. Create `packages/client/src/components/auth/LoginPage.tsx`:
   - A form with email and password fields
   - Uses `authClient.signIn.email({ email, password })` on submit
   - Shows error message if login fails (from error.message)
   - Has a link/button to switch to signup page
   - Style with Tailwind: dark theme consistent with existing app (bg-gray-800, text-gray-100)
   - Center the form on screen (flex items-center justify-center min-h-screen)
   - Form card: bg-gray-800 rounded-lg shadow-lg p-8 w-full max-w-md
   - Inputs: bg-gray-700 text-gray-100 border-gray-600 focus:border-blue-500
   - Submit button: bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2
   - Accept an `onSwitchToSignup` callback prop to toggle between login/signup

4. Create `packages/client/src/components/auth/SignupPage.tsx`:
   - A form with name, email, and password fields
   - Uses `authClient.signUp.email({ name, email, password })` on submit
   - Shows error message if signup fails
   - Has a link/button to switch to login page
   - Same dark Tailwind styling as LoginPage
   - Accept an `onSwitchToLogin` callback prop
   - Note: Better Auth's `autoSignIn: true` config means signup automatically creates a session
  </action>
  <verify>
    Run `pnpm --filter @hex-crawl/client exec -- npx tsc --noEmit` to confirm no TypeScript errors.
    Check that `packages/client/src/lib/auth-client.ts` exists and exports `authClient`.
    Check that LoginPage and SignupPage components exist and import from auth-client.
  </verify>
  <done>
    Better Auth React client configured with server baseURL. LoginPage renders email/password form and calls signIn. SignupPage renders name/email/password form and calls signUp. Both styled with dark Tailwind theme matching existing app design.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthGuard and wire auth into App routing</name>
  <files>
    packages/client/src/components/auth/AuthGuard.tsx
    packages/client/src/App.tsx
  </files>
  <action>
1. Create `packages/client/src/components/auth/AuthGuard.tsx`:
   ```typescript
   import { useState } from "react";
   import { authClient } from "../../lib/auth-client";
   import { LoginPage } from "./LoginPage";
   import { SignupPage } from "./SignupPage";

   export function AuthGuard({ children }: { children: React.ReactNode }) {
     const { data: session, isPending } = authClient.useSession();
     const [showSignup, setShowSignup] = useState(false);

     if (isPending) {
       return (
         <div className="flex items-center justify-center min-h-screen bg-gray-900">
           <div className="text-gray-400 text-lg">Loading...</div>
         </div>
       );
     }

     if (!session) {
       if (showSignup) {
         return <SignupPage onSwitchToLogin={() => setShowSignup(false)} />;
       }
       return <LoginPage onSwitchToSignup={() => setShowSignup(true)} />;
     }

     return <>{children}</>;
   }
   ```
   - When session is loading: show a centered loading spinner/text on dark background
   - When no session: show LoginPage (default) or SignupPage based on toggle state
   - When session exists: render children (the actual app)

2. Update `packages/client/src/App.tsx`:
   - Wrap the existing app content with `<AuthGuard>`:
     ```tsx
     import { AuthGuard } from "./components/auth/AuthGuard";

     function App() {
       return (
         <AuthGuard>
           {/* existing app content (MapView, etc.) */}
         </AuthGuard>
       );
     }
     ```
   - Preserve ALL existing app functionality inside the AuthGuard
   - Add a simple logout button somewhere accessible (e.g., top-right corner of the app layout):
     - Import `authClient` from `./lib/auth-client`
     - Add a small logout button that calls `authClient.signOut()`
     - Style: fixed top-right or in the existing header/panel area, text-gray-400 hover:text-white

3. Add `VITE_API_URL` to client environment:
   - Create `packages/client/.env` with:
     ```
     VITE_API_URL=http://localhost:3000
     ```
   - Add this to `.gitignore` if not already covered

4. Ensure the Vite dev server is still binding to 0.0.0.0 (check vite.config.ts -- it should already be configured from Phase 1).
  </action>
  <verify>
    1. Run `pnpm --filter @hex-crawl/client exec -- npx tsc --noEmit` -- no TypeScript errors
    2. Start the server: `cd packages/server && npx tsx src/index.ts &`
    3. Start the client: `cd packages/client && npx vite --host 0.0.0.0 &`
    4. The app should show the login page when not authenticated
    5. After signing up or logging in, the hex map (existing Phase 1 content) should appear
    6. Refreshing the browser should keep the user logged in (session cookie persists)
    7. Clicking logout should return to the login page
  </verify>
  <done>
    AuthGuard wraps the entire app, showing login/signup when unauthenticated and the hex map when authenticated. Session persists across browser refreshes via Better Auth cookies. Logout button available in the app UI. Login/signup toggle works seamlessly.
  </done>
</task>

</tasks>

<verification>
1. Browser shows login page when unauthenticated
2. User can sign up with name, email, password
3. User can log in with email, password
4. After login, hex map (Phase 1 content) is visible
5. Browser refresh maintains the session (no re-login needed)
6. Logout returns to login page
7. Error messages display for invalid credentials
</verification>

<success_criteria>
- Better Auth React client configured and working with cross-origin server
- Login and signup forms styled consistently with existing dark theme
- AuthGuard prevents unauthenticated access to the app
- Session persists across browser refreshes
- User can log out
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-authentication/02-03-SUMMARY.md`
</output>
