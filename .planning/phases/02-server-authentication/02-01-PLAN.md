---
phase: 02-server-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/package.json
  - packages/server/tsconfig.json
  - packages/server/drizzle.config.ts
  - packages/server/.env
  - packages/server/src/index.ts
  - packages/server/src/app.ts
  - packages/server/src/auth.ts
  - packages/server/src/db/index.ts
  - packages/server/src/db/schema/auth.ts
  - packages/server/src/db/schema/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Hono server starts and responds to HTTP requests on port 3000 bound to 0.0.0.0"
    - "Better Auth handles signup and login at /api/auth/* endpoints"
    - "PostgreSQL database is running with a hexcrawl_dev database and user"
    - "CORS allows cross-origin requests from localhost:5173 with credentials"
    - "User session persists across server restarts (stored in PostgreSQL)"
  artifacts:
    - path: "packages/server/src/index.ts"
      provides: "Server entry point with @hono/node-server"
      contains: "serve"
    - path: "packages/server/src/app.ts"
      provides: "Hono app with CORS middleware and auth route mount"
      contains: "cors"
    - path: "packages/server/src/auth.ts"
      provides: "Better Auth instance with Drizzle adapter"
      contains: "betterAuth"
    - path: "packages/server/src/db/index.ts"
      provides: "Drizzle ORM connection via pg Pool"
      contains: "drizzle"
    - path: "packages/server/src/db/schema/auth.ts"
      provides: "Better Auth generated schema (user, session, account, verification tables)"
      contains: "pgTable"
  key_links:
    - from: "packages/server/src/app.ts"
      to: "packages/server/src/auth.ts"
      via: "auth.handler mount on /api/auth/*"
      pattern: "auth\\.handler"
    - from: "packages/server/src/auth.ts"
      to: "packages/server/src/db/index.ts"
      via: "drizzleAdapter(db)"
      pattern: "drizzleAdapter"
    - from: "packages/server/src/db/index.ts"
      to: "PostgreSQL"
      via: "pg Pool with DATABASE_URL"
      pattern: "Pool"
---

<objective>
Set up the Hono server with PostgreSQL, Drizzle ORM, and Better Auth so that users can create accounts and log in via /api/auth/* endpoints.

Purpose: This is the foundation for all server-side functionality. Every subsequent plan depends on the server being able to authenticate users and persist data.
Output: A running Hono server on port 3000 with Better Auth handling email/password signup and login, backed by PostgreSQL via Drizzle ORM.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-authentication/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up PostgreSQL, install dependencies, scaffold server package</name>
  <files>
    packages/server/package.json
    packages/server/tsconfig.json
    packages/server/.env
    package.json
  </files>
  <action>
1. Install and start PostgreSQL 16:
   ```bash
   sudo apt install -y postgresql-16
   sudo systemctl start postgresql
   sudo systemctl enable postgresql
   ```

2. Create the dev database and user:
   ```bash
   sudo -u postgres createuser hexcrawl_dev 2>/dev/null || true
   sudo -u postgres createdb hexcrawl_dev --owner=hexcrawl_dev 2>/dev/null || true
   sudo -u postgres psql -c "ALTER USER hexcrawl_dev WITH PASSWORD 'dev_password';"
   ```

3. Update `packages/server/package.json` with full configuration:
   ```json
   {
     "name": "@hex-crawl/server",
     "private": true,
     "version": "0.0.1",
     "type": "module",
     "scripts": {
       "dev": "tsx watch src/index.ts",
       "build": "tsc",
       "start": "node dist/index.js",
       "db:generate": "drizzle-kit generate",
       "db:migrate": "drizzle-kit migrate",
       "db:push": "drizzle-kit push",
       "db:studio": "drizzle-kit studio"
     },
     "dependencies": {
       "hono": "^4.11.0",
       "@hono/node-server": "^1.14.0",
       "better-auth": "^1.4.0",
       "drizzle-orm": "^0.45.0",
       "pg": "^8.16.0",
       "zod": "^4.0.0",
       "@hono/zod-validator": "^0.5.0",
       "dotenv": "^16.5.0"
     },
     "devDependencies": {
       "drizzle-kit": "^0.31.0",
       "@types/pg": "^8.15.0",
       "tsx": "^4.19.0",
       "typescript": "~5.8.0",
       "@types/node": "^22.0.0"
     }
   }
   ```

4. Create `packages/server/tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "ESNext",
       "moduleResolution": "bundler",
       "esModuleInterop": true,
       "strict": true,
       "outDir": "dist",
       "rootDir": "src",
       "declaration": true,
       "skipLibCheck": true,
       "resolveJsonModule": true,
       "isolatedModules": true,
       "forceConsistentCasingInFileNames": true
     },
     "include": ["src/**/*", "drizzle.config.ts"],
     "exclude": ["node_modules", "dist"]
   }
   ```

5. Create `packages/server/.env`:
   ```
   DATABASE_URL=postgresql://hexcrawl_dev:dev_password@localhost:5432/hexcrawl_dev
   BETTER_AUTH_SECRET=<generate using: node -e "console.log(require('crypto').randomBytes(32).toString('base64'))">
   BETTER_AUTH_URL=http://localhost:3000
   PORT=3000
   ```
   Generate the BETTER_AUTH_SECRET dynamically using the node command.

6. Add `.env` to `.gitignore` (at repo root) if not already present. Add `packages/server/.env` specifically.

7. Update root `package.json` to add a `dev:server` script:
   ```json
   "dev:server": "pnpm --filter @hex-crawl/server dev"
   ```

8. Run `pnpm install` from the workspace root to install all dependencies.
  </action>
  <verify>
    Run `pnpm --filter @hex-crawl/server exec -- tsx --version` to confirm tsx is installed.
    Run `sudo -u postgres psql -d hexcrawl_dev -c "SELECT 1"` to confirm database is accessible.
    Run `pnpm --filter @hex-crawl/server exec -- npx drizzle-kit --version` to confirm drizzle-kit is installed.
  </verify>
  <done>
    PostgreSQL 16 is running with hexcrawl_dev database and user. Server package has all dependencies installed. TypeScript, tsx, and drizzle-kit are available. .env file has DATABASE_URL and generated BETTER_AUTH_SECRET.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Hono server with Better Auth, Drizzle connection, and auth schema</name>
  <files>
    packages/server/src/index.ts
    packages/server/src/app.ts
    packages/server/src/auth.ts
    packages/server/src/db/index.ts
    packages/server/src/db/schema/auth.ts
    packages/server/src/db/schema/index.ts
    packages/server/drizzle.config.ts
  </files>
  <action>
1. Create `packages/server/src/db/index.ts` -- Drizzle + pg Pool connection:
   - Import `dotenv/config` at the top to load .env
   - Create a `Pool` from `pg` using `process.env.DATABASE_URL`
   - Export `db` via `drizzle({ client: pool, schema })` from `drizzle-orm/node-postgres`
   - Import `* as schema` from `./schema/index.js`

2. Create `packages/server/src/auth.ts` -- Better Auth instance:
   - Import `betterAuth` from `better-auth`
   - Import `drizzleAdapter` from `better-auth/adapters/drizzle`
   - Import `db` from `./db/index.js`
   - Configure with:
     - `database: drizzleAdapter(db, { provider: "pg" })`
     - `emailAndPassword: { enabled: true, minPasswordLength: 8, autoSignIn: true }`
     - `session: { expiresIn: 60 * 60 * 24 * 7, updateAge: 60 * 60 * 24 }`
     - `trustedOrigins: ["http://localhost:5173"]`
   - Export `auth`

3. Create `packages/server/src/app.ts` -- Hono app:
   - Import `Hono` from `hono`, `cors` from `hono/cors`
   - Import `auth` from `./auth.js`
   - Define `AppVariables` type with `user` and `session` from `auth.$Infer.Session`
   - Create `const app = new Hono<{ Variables: AppVariables }>()`
   - Register CORS middleware BEFORE routes:
     ```
     app.use("/api/*", cors({
       origin: "http://localhost:5173",
       allowHeaders: ["Content-Type", "Authorization"],
       allowMethods: ["POST", "GET", "PUT", "DELETE", "OPTIONS"],
       credentials: true,
     }))
     ```
   - Mount Better Auth handler:
     ```
     app.on(["POST", "GET"], "/api/auth/**", (c) => auth.handler(c.req.raw))
     ```
     IMPORTANT: Use `/api/auth/**` (double star) to match all sub-paths.
   - Add a health check route: `app.get("/api/health", (c) => c.json({ status: "ok" }))`
   - Export `default app` and `type AppType`

4. Create `packages/server/src/index.ts` -- entry point:
   - Import `dotenv/config` first (before any other imports)
   - Import `serve` from `@hono/node-server`
   - Import `app` from `./app.js`
   - Call `serve({ fetch: app.fetch, port: Number(process.env.PORT) || 3000, hostname: "0.0.0.0" }, ...)`
   - Log `Server running at http://0.0.0.0:${info.port}` in callback

5. Generate Better Auth schema:
   - Run `cd packages/server && npx @better-auth/cli generate --output src/db/schema/auth.ts`
   - This generates the user, session, account, verification table definitions in Drizzle format.
   - If the CLI doesn't work or generates incorrect output, manually create the schema based on Better Auth docs with pgTable definitions for user, session, account, verification.

6. Create `packages/server/src/db/schema/index.ts` -- barrel export:
   - `export * from "./auth.js"`
   - (campaign and invitation exports will be added in Plan 02)

7. Create `packages/server/drizzle.config.ts`:
   - Import `defineConfig` from `drizzle-kit`
   - Configure with `schema: "./src/db/schema/index.ts"`, `out: "./drizzle"`, `dialect: "postgresql"`, `dbCredentials: { url: process.env.DATABASE_URL! }`

8. Push schema to database:
   - Run `cd packages/server && npx drizzle-kit push` to create tables directly (faster for dev than generate+migrate)

9. Verify by starting the server:
   - Run `cd packages/server && npx tsx src/index.ts` (briefly, to confirm it starts)
   - Curl `http://localhost:3000/api/health` to verify the health check returns `{"status":"ok"}`
   - Stop the server after verification
  </action>
  <verify>
    Start the server with `cd packages/server && npx tsx src/index.ts &amp;` then:
    1. `curl http://localhost:3000/api/health` returns `{"status":"ok"}`
    2. `curl -X POST http://localhost:3000/api/auth/sign-up/email -H "Content-Type: application/json" -d '{"name":"Test User","email":"test@example.com","password":"testpass123"}' -v` returns a 200 response with user data and a Set-Cookie header
    3. `sudo -u postgres psql -d hexcrawl_dev -c "SELECT id, email FROM \"user\" LIMIT 1"` shows the created user
    Kill the server process after verification.
  </verify>
  <done>
    Hono server starts on port 3000 bound to 0.0.0.0. Better Auth handles /api/auth/* routes. User signup creates a row in the PostgreSQL user table. CORS is configured for localhost:5173 with credentials. Health check responds at /api/health.
  </done>
</task>

</tasks>

<verification>
1. PostgreSQL 16 is running with hexcrawl_dev database accessible
2. `pnpm --filter @hex-crawl/server dev` starts the server on port 3000
3. `curl http://localhost:3000/api/health` returns `{"status":"ok"}`
4. Signup via Better Auth creates a user in PostgreSQL
5. Login via Better Auth returns a session cookie
6. CORS headers present on cross-origin responses from localhost:5173
</verification>

<success_criteria>
- Server package fully scaffolded with Hono, Better Auth, Drizzle ORM, and PostgreSQL
- User can sign up and log in via /api/auth/* endpoints
- Session persists in PostgreSQL (survives server restart)
- CORS configured for cross-origin client access with credentials
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-authentication/02-01-SUMMARY.md`
</output>
