---
phase: 01-hex-grid-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/client/src/hex/generation.ts
  - packages/client/src/components/MapView.tsx
  - packages/client/src/components/SidePanel.tsx
  - packages/client/src/components/CreationDialog.tsx
  - packages/client/src/components/TerrainPalette.tsx
autonomous: true

must_haves:
  truths:
    - "Terrain generation creates multi-hex clustered regions (not pure random noise)"
    - "Side panel shows hex info when a hex is selected (coordinates, terrain type)"
    - "Creation dialog lets user set map name and grid size before generating"
    - "Terrain palette shows all 10 terrain types for manual assignment"
  artifacts:
    - path: "packages/client/src/hex/generation.ts"
      provides: "Seed-and-grow BFS terrain generation algorithm"
      exports: ["generateTerrain"]
      min_lines: 60
    - path: "packages/client/src/components/SidePanel.tsx"
      provides: "Right-side panel showing hex info and terrain palette"
      exports: ["SidePanel"]
      min_lines: 40
    - path: "packages/client/src/components/CreationDialog.tsx"
      provides: "Map creation dialog with name, grid width, grid height inputs"
      exports: ["CreationDialog"]
      min_lines: 50
    - path: "packages/client/src/components/TerrainPalette.tsx"
      provides: "Grid of terrain type buttons for manual terrain assignment"
      exports: ["TerrainPalette"]
      min_lines: 30
    - path: "packages/client/src/components/MapView.tsx"
      provides: "Main layout component combining canvas and side panel"
      exports: ["MapView"]
      min_lines: 20
  key_links:
    - from: "packages/client/src/hex/generation.ts"
      to: "packages/client/src/hex/neighbors.ts"
      via: "BFS uses neighbor lookup for region growing"
      pattern: "getNeighborCoords"
    - from: "packages/client/src/components/SidePanel.tsx"
      to: "packages/client/src/stores/useUIStore.ts"
      via: "reads selectedHexes and hoveredHex"
      pattern: "useUIStore"
    - from: "packages/client/src/components/SidePanel.tsx"
      to: "packages/client/src/stores/useMapStore.ts"
      via: "reads hex terrain data for display"
      pattern: "useMapStore"
    - from: "packages/client/src/components/CreationDialog.tsx"
      to: "packages/client/src/stores/useMapStore.ts"
      via: "calls initializeMap on submit"
      pattern: "initializeMap"
---

<objective>
Build the terrain generation algorithm (seed-and-grow BFS with adjacency intelligence) and all React UI components: MapView layout, SidePanel for hex info display, CreationDialog for new map creation, and TerrainPalette for manual terrain assignment. These components use Tailwind CSS for styling and read/write Zustand stores.

Purpose: The terrain generator produces natural-looking clustered regions (not random noise) -- water connects to coast, mountains cluster together. The React UI provides the DM's interface for creating maps, viewing hex info, and changing terrain. These are the non-canvas UI elements that surround the hex map.
Output: Terrain generation function, four React components styled with Tailwind CSS, all wired to Zustand stores.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-hex-grid-foundation/01-CONTEXT.md
@.planning/phases/01-hex-grid-foundation/01-RESEARCH.md
@.planning/phases/01-hex-grid-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement seed-and-grow BFS terrain generation with adjacency rules</name>
  <files>
    packages/client/src/hex/generation.ts
  </files>
  <action>
    Create `packages/client/src/hex/generation.ts` implementing a seed-and-grow terrain clustering algorithm:

    **`generateTerrain(gridWidth: number, gridHeight: number): Map<string, { terrain: TerrainType; terrainVariant: number }>`**

    Algorithm (seed-and-grow BFS):

    1. **Seed phase** (~12-18% of hexes become seeds):
       - Iterate all hex coordinates in the grid
       - Each hex has ~15% chance of becoming a seed
       - Assign a random terrain type from: forest, desert, grassland, mountain, water, swamp (primary 6 -- arctic, coast, underdark, urban are secondary)
       - Store seeds in a list for BFS expansion

    2. **Grow phase** (BFS expansion from seeds):
       - Create a BFS queue initialized with all seed hexes
       - For each hex in queue, look at its unassigned neighbors (using `getNeighborCoords` from hex/neighbors.ts)
       - Each neighbor has a ~70% chance of adopting the parent's terrain (probability decreases with distance from seed: 70% for distance 1, 50% for distance 2, 30% for distance 3)
       - If a neighbor is not adopted, it stays unassigned for now
       - Track growth distance from each seed to control cluster size

    3. **Adjacency rules** (applied during grow phase):
       - Water seeds: neighbors that ARE assigned water automatically get coast as their terrain (unless they're also water). This creates natural coastlines.
       - Mountain: can spread to adjacent hexes, but also has a chance of producing forest neighbors (mountain-forest transition)
       - Desert: neighbors tend to transition through grassland before other terrain types

    4. **Fill phase** (assign remaining unassigned hexes):
       - Find all hexes still unassigned after BFS
       - For each, find the nearest assigned neighbor and adopt its terrain type
       - If no neighbors assigned (shouldn't happen for reasonable grid sizes), default to grassland

    5. **Variant assignment:**
       - For each hex, assign a random terrainVariant (0, 1, or 2) for texture variety

    The function returns a Map<string, { terrain, terrainVariant }> keyed by "q,r".

    Export: `generateTerrain(gridWidth, gridHeight)` as the main public function.

    IMPORTANT: Use `getNeighborCoords` from hex/neighbors.ts for neighbor lookups -- do NOT hand-roll direction offset arrays.
    IMPORTANT: The algorithm should handle edge cases: very small grids (3x3), very large grids (50x50), and grids where seeds are sparse.
  </action>
  <verify>
    1. TypeScript compiles: `pnpm -r exec -- npx tsc --noEmit`
    2. Write a temporary test: call `generateTerrain(15, 15)`, verify:
       - Returns 225 entries (15x15 grid)
       - Every entry has a valid TerrainType
       - Water hexes have coast neighbors (check at least one water hex's neighbors)
       - Terrain is clustered: pick a random hex, count how many of its neighbors share its terrain -- average should be > 2 (not pure random where average would be ~1)
       - Multiple terrain types present (not all one type)
    3. Generate 3 times and verify results look different (randomized, not deterministic)
  </verify>
  <done>
    Terrain generation produces natural-looking clustered regions. Water forms bodies with coast borders. Mountains cluster together. Terrain types form multi-hex regions, not salt-and-pepper noise. Algorithm handles all grid sizes from 3x3 to 50x50.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build React UI components -- MapView, SidePanel, CreationDialog, TerrainPalette</name>
  <files>
    packages/client/src/components/MapView.tsx
    packages/client/src/components/SidePanel.tsx
    packages/client/src/components/CreationDialog.tsx
    packages/client/src/components/TerrainPalette.tsx
  </files>
  <action>
    Build all React UI components using Tailwind CSS v4 classes. These components sit outside the PixiJS canvas and communicate via Zustand stores.

    **packages/client/src/components/MapView.tsx -- Main layout:**
    - Flex layout: canvas area (flex-1) + side panel (w-[300px], right side)
    - Canvas area contains the HexMapCanvas component (Plan 02 will create this -- for now, render a placeholder div with text "Canvas loading...")
    - Side panel always visible but collapsible (toggle button)
    - Full viewport height (`h-screen`)
    - Dark theme: dark background (bg-gray-900), light text (text-gray-100)

    **packages/client/src/components/SidePanel.tsx -- Hex info panel:**
    - 300px wide, right-side, full height, dark background (bg-gray-800), subtle left border
    - Shows different content based on `useUIStore.sidePanel` state:
      - 'info': Show selected hex info (coordinates q,r displayed, terrain type with color swatch, terrain variant number). If no hex selected, show "Click a hex to select it" message. If multiple hexes selected, show count and list terrain types.
      - 'terrain': Show TerrainPalette component for manual terrain assignment
      - 'create': Show CreationDialog
      - 'import-export': Placeholder for Plan 04
    - Tab buttons at top to switch between panels: Info, Terrain, Create, Import/Export
    - Read from `useUIStore` for selectedHexes, from `useMapStore` for hex data

    **packages/client/src/components/CreationDialog.tsx -- Map creation:**
    - Form with fields: Map Name (text input, default "New Map"), Grid Width (number input, default 15, range 5-100), Grid Height (number input, default 15, range 5-100)
    - "Generate Map" button that:
      1. Calls `generateTerrain(width, height)` from hex/generation.ts
      2. Creates HexData entries from the generation result
      3. Calls `useMapStore.getState().initializeMap(name, width, height, hexes)`
      4. Switches side panel back to 'info' mode
    - "Cancel" button that switches panel back to 'info'
    - Input validation: name required (min 1 char), width/height must be integers 5-100
    - Styled with Tailwind: dark inputs (bg-gray-700, text-white), rounded buttons, spacing

    **packages/client/src/components/TerrainPalette.tsx -- Terrain picker:**
    - Grid of 10 terrain type buttons, each showing:
      - Color swatch (small square with terrain color from TERRAIN_COLORS)
      - Terrain name (capitalized)
    - Layout: 2 columns, compact grid
    - Clicking a terrain type button:
      1. Gets currently selected hexes from `useUIStore`
      2. Calls `useMapStore.getState().setTerrainBatch(selectedKeys, terrain)` to assign that terrain to all selected hexes
    - If no hexes selected, show helper text: "Select hexes on the map first, then click a terrain type to assign it"
    - Highlight the currently active terrain (if all selected hexes share same terrain, highlight that button)

    IMPORTANT: Use Tailwind CSS classes directly (NOT CSS modules or styled-components). Tailwind v4 is already configured.
    IMPORTANT: All state reads use Zustand hooks. No prop drilling for map/UI state.
    IMPORTANT: Components should render correctly even before the canvas exists (Plan 02). Use conditional rendering where needed.
  </action>
  <verify>
    1. `pnpm dev` renders the MapView layout with side panel visible
    2. Side panel tabs work: clicking Info/Terrain/Create switches content
    3. CreationDialog: entering name "Test Map", width 10, height 10 and clicking Generate creates map data in Zustand store (verify with React DevTools or console: `useMapStore.getState().hexes.size` should be 100)
    4. TerrainPalette: shows 10 terrain types with correct color swatches
    5. SidePanel info tab: shows "Click a hex to select it" when nothing selected
    6. All components render with dark theme styling (no white backgrounds, no unstyled raw HTML)
    7. TypeScript compiles with zero errors
  </verify>
  <done>
    All React UI components functional: MapView layout (canvas + side panel), SidePanel with tab navigation and hex info display, CreationDialog generates maps with clustered terrain, TerrainPalette shows 10 terrain types for manual assignment. Components communicate via Zustand stores. Dark theme applied throughout with Tailwind CSS.
  </done>
</task>

</tasks>

<verification>
1. Terrain generation produces clustered regions (visual inspection when connected to canvas in Plan 04)
2. Side panel renders at 300px on the right side with dark theme
3. Tab navigation switches between Info, Terrain, Create, Import/Export panels
4. Creation dialog creates a new map with specified dimensions
5. Terrain palette shows all 10 terrain types with correct colors
6. All components compile without TypeScript errors
7. Zustand stores update correctly when UI actions are taken
</verification>

<success_criteria>
- generateTerrain produces clustered terrain with adjacency rules (water-coast, mountain clusters)
- SidePanel shows hex info for selected hexes (coordinates, terrain type)
- CreationDialog generates new maps with customizable name and dimensions
- TerrainPalette enables manual terrain assignment on selected hexes
- All components use Tailwind CSS dark theme
- All state management through Zustand (no prop drilling)
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-hex-grid-foundation/01-03-SUMMARY.md`
</output>
