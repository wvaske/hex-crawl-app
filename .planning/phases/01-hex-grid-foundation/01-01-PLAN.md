---
phase: 01-hex-grid-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pnpm-workspace.yaml
  - package.json
  - packages/client/package.json
  - packages/client/vite.config.ts
  - packages/client/tsconfig.json
  - packages/client/tsconfig.app.json
  - packages/client/tsconfig.node.json
  - packages/client/index.html
  - packages/client/src/main.tsx
  - packages/client/src/App.tsx
  - packages/client/src/styles/index.css
  - packages/client/src/vite-env.d.ts
  - packages/shared/package.json
  - packages/shared/tsconfig.json
  - packages/shared/src/index.ts
  - packages/shared/src/hex-types.ts
  - packages/shared/src/map-schema.ts
  - packages/client/src/hex/grid.ts
  - packages/client/src/hex/coordinates.ts
  - packages/client/src/hex/terrain.ts
  - packages/client/src/hex/neighbors.ts
  - packages/client/src/types/hex.ts
  - packages/client/src/types/map.ts
  - packages/client/src/stores/useMapStore.ts
  - packages/client/src/stores/useUIStore.ts
  - packages/server/package.json
autonomous: true

must_haves:
  truths:
    - "pnpm dev starts Vite dev server and renders a React page in the browser"
    - "TypeScript compiles with zero errors across all packages"
    - "Honeycomb-grid creates a flat-top hex grid with correct axial coordinates"
    - "Zustand stores hold hex map state and UI state with proper TypeScript types"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "pnpm monorepo workspace config"
      contains: "packages"
    - path: "packages/shared/src/hex-types.ts"
      provides: "Shared hex coordinate and terrain type definitions"
      exports: ["HexCoord", "TerrainType", "HexData"]
    - path: "packages/shared/src/map-schema.ts"
      provides: "Zod schemas for map import/export validation"
      exports: ["MapExportSchema"]
    - path: "packages/client/src/hex/grid.ts"
      provides: "Honeycomb-grid GameHex class and grid factory"
      exports: ["GameHex", "createGrid"]
    - path: "packages/client/src/stores/useMapStore.ts"
      provides: "Zustand store for hex map data"
      exports: ["useMapStore"]
    - path: "packages/client/src/stores/useUIStore.ts"
      provides: "Zustand store for UI state"
      exports: ["useUIStore"]
  key_links:
    - from: "packages/client/src/hex/grid.ts"
      to: "honeycomb-grid"
      via: "defineHex with Orientation.FLAT"
      pattern: "Orientation\\.FLAT"
    - from: "packages/client/src/stores/useMapStore.ts"
      to: "packages/shared/src/hex-types.ts"
      via: "import shared types"
      pattern: "@hex-crawl/shared"
    - from: "packages/client/package.json"
      to: "packages/shared/package.json"
      via: "workspace dependency"
      pattern: "workspace:\\*"
---

<objective>
Scaffold the pnpm monorepo with client, shared, and server packages. Install all dependencies (PixiJS 8, @pixi/react, honeycomb-grid, pixi-viewport, Zustand, Tailwind CSS 4, Zod). Create the hex math foundation using honeycomb-grid (flat-top GameHex class, grid factory, coordinate helpers, terrain types). Set up Zustand stores for map state and UI state. Establish shared types for hex data and map export schemas.

Purpose: Every subsequent plan depends on this project structure, installed dependencies, hex type definitions, coordinate math, and state management. This is the foundation layer.
Output: Working monorepo with dev server, all hex math utilities, shared types, and Zustand stores ready for consumption by rendering and UI plans.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-hex-grid-foundation/01-CONTEXT.md
@.planning/phases/01-hex-grid-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold pnpm monorepo with all dependencies</name>
  <files>
    pnpm-workspace.yaml
    package.json
    packages/client/package.json
    packages/client/vite.config.ts
    packages/client/tsconfig.json
    packages/client/tsconfig.app.json
    packages/client/tsconfig.node.json
    packages/client/index.html
    packages/client/src/main.tsx
    packages/client/src/App.tsx
    packages/client/src/styles/index.css
    packages/client/src/vite-env.d.ts
    packages/shared/package.json
    packages/shared/tsconfig.json
    packages/shared/src/index.ts
    packages/server/package.json
  </files>
  <action>
    Create the monorepo structure inside the existing workspace root:

    1. Create `pnpm-workspace.yaml` with `packages: ['packages/*']`

    2. Create root `package.json`:
       - name: "hex-crawl", private: true
       - scripts: `"dev": "pnpm --filter @hex-crawl/client dev"`, `"build": "pnpm --filter @hex-crawl/client build"`, `"dev:all": "pnpm --parallel --filter './packages/*' dev"`

    3. Scaffold `packages/client` using `pnpm create vite packages/client --template react-ts` (or manually create equivalent structure):
       - `vite.config.ts` with react plugin + `@tailwindcss/vite` plugin (see RESEARCH.md Pattern: Vite + Tailwind CSS 4)
       - `index.html` with root div
       - `src/main.tsx` rendering App into root
       - `src/App.tsx` with placeholder "HexCrawl" heading
       - `src/styles/index.css` with `@import "tailwindcss";`
       - `src/vite-env.d.ts` with Vite client types reference
       - tsconfig files: base tsconfig.json (references), tsconfig.app.json (src), tsconfig.node.json (vite config)

    4. Install client dependencies:
       ```
       pnpm add pixi.js@^8.15.0 @pixi/react@^8.0.5 honeycomb-grid@^4.1.5 pixi-viewport@^6.0.3 zustand@^5.0.10 react-router@^7.13.0 zod@^4
       pnpm add -D tailwindcss @tailwindcss/vite typescript @types/react @types/react-dom
       ```

    5. Create `packages/shared`:
       - `package.json`: name "@hex-crawl/shared", main "src/index.ts", types "src/index.ts"
       - `tsconfig.json` with strict TypeScript, ES2022 target
       - `src/index.ts` barrel export (empty initially, will export types)
       - Add `honeycomb-grid@^4.1.5` and `zod@^4` as shared dependencies

    6. Create `packages/server` placeholder:
       - `package.json`: name "@hex-crawl/server", private: true (placeholder for Phase 2)

    7. Add workspace dependency in client: `"@hex-crawl/shared": "workspace:*"`

    8. Run `pnpm install` from root to link workspaces.

    IMPORTANT: Use `@tailwindcss/vite` plugin in vite.config.ts (NOT PostCSS). Tailwind CSS v4 uses CSS-first config with `@import "tailwindcss"` -- no tailwind.config.js file needed.
    IMPORTANT: Ensure Node.js version is 20.19+ or 22.12+ (required by Vite 7.3.1). Check with `node -v` first.
  </action>
  <verify>
    1. `pnpm dev` starts Vite dev server without errors
    2. Browser shows the placeholder App component
    3. `pnpm -r exec -- npx tsc --noEmit` passes with zero TypeScript errors across all packages
    4. `ls packages/client/node_modules/pixi.js` confirms PixiJS installed
    5. `ls packages/client/node_modules/honeycomb-grid` confirms honeycomb-grid installed
  </verify>
  <done>
    Monorepo runs: `pnpm dev` serves a React page. All dependencies installed. TypeScript compiles cleanly. Three packages exist (client, shared, server placeholder). Workspace linking works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hex math foundation, shared types, and Zustand stores</name>
  <files>
    packages/shared/src/hex-types.ts
    packages/shared/src/map-schema.ts
    packages/shared/src/index.ts
    packages/client/src/hex/grid.ts
    packages/client/src/hex/coordinates.ts
    packages/client/src/hex/terrain.ts
    packages/client/src/hex/neighbors.ts
    packages/client/src/types/hex.ts
    packages/client/src/types/map.ts
    packages/client/src/stores/useMapStore.ts
    packages/client/src/stores/useUIStore.ts
  </files>
  <action>
    Create all hex math utilities, shared types, and state management:

    **packages/shared/src/hex-types.ts:**
    - `HexCoord`: `{ q: number; r: number }` (axial coordinates)
    - `CubeCoord`: `{ q: number; r: number; s: number }`
    - `TerrainType`: union type of 10 built-in terrains: 'forest' | 'desert' | 'grassland' | 'mountain' | 'water' | 'swamp' | 'arctic' | 'coast' | 'underdark' | 'urban'
    - `TERRAIN_TYPES`: readonly array of all terrain type strings
    - `TERRAIN_COLORS`: Record<TerrainType, string> mapping terrain to hex colors (forest=#2d5a27, desert=#c4a35a, grassland=#7ec850, mountain=#8b7355, water=#3b7dd8, swamp=#4a6741, arctic=#e8f0f2, coast=#d4bc65, underdark=#2a1a3e, urban=#8a8a8a)
    - `HexData`: `{ q: number; r: number; terrain: TerrainType; terrainVariant: number }`
    - `hexKey(q, r)`: returns `"${q},${r}"` string key for Map lookups
    - `parseHexKey(key)`: returns `{ q, r }` from string key

    **packages/shared/src/map-schema.ts:**
    - Zod schema `HexDataSchema`: validates HexData objects
    - Zod schema `MapExportSchema`: validates full map export with version (literal 1), name, gridWidth, gridHeight, hexSize, orientation ('flat' | 'pointy'), and hexes array
    - Export `MapExport` type inferred from schema

    **packages/shared/src/index.ts:** barrel export all shared types and schemas

    **packages/client/src/hex/grid.ts:**
    - Import `defineHex`, `Grid`, `rectangle`, `Orientation` from honeycomb-grid
    - Create `GameHex` class extending `defineHex({ dimensions: 40, orientation: Orientation.FLAT, origin: 'topLeft', offset: -1 })`
    - `createGrid(width: number, height: number)`: returns `new Grid(GameHex, rectangle({ width, height }))` -- always pass traverser to create stateful grid (PITFALL 5)
    - Export `GameHex`, `createGrid`, and re-export `Orientation`

    **packages/client/src/hex/coordinates.ts:**
    - `hexToPixel(hex: GameHex)`: returns `{ x: hex.x, y: hex.y }` (thin wrapper for clarity)
    - `pixelToHex(worldX, worldY, hexPrototype)`: uses honeycomb-grid's coordinate conversion to find hex at world point, with cube rounding (round q, r, s; fix largest delta to satisfy q+r+s=0)
    - `hexToKey(hex)`: returns `"${hex.q},${hex.r}"`

    **packages/client/src/hex/terrain.ts:**
    - `TERRAIN_VARIANTS_COUNT`: Record<TerrainType, number> -- each terrain gets 3 variants
    - `assignRandomVariant(terrain: TerrainType)`: returns random variant index 0-2
    - Terrain color constants re-exported from shared for easy access

    **packages/client/src/hex/neighbors.ts:**
    - `getNeighborCoords(q, r)`: returns array of 6 neighbor axial coordinates for flat-top hex
    - `hexDistance(a: HexCoord, b: HexCoord)`: cube distance formula

    **packages/client/src/types/hex.ts:** re-export shared hex types for client convenience
    **packages/client/src/types/map.ts:** re-export shared map types for client convenience

    **packages/client/src/stores/useMapStore.ts:**
    - State: `hexes: Map<string, HexData>`, `mapName: string`, `gridWidth: number`, `gridHeight: number`, `hexSize: number`
    - Actions: `initializeMap(name, width, height, hexes)`, `setTerrain(key, terrain)`, `setTerrainBatch(keys[], terrain)` (for multi-select painting), `clearMap()`
    - IMPORTANT: Always create new Map instances when updating hexes (PITFALL 6 -- Zustand Map mutation)

    **packages/client/src/stores/useUIStore.ts:**
    - State: `selectedHexes: Set<string>`, `hoveredHex: string | null`, `sidePanel: 'info' | 'terrain' | 'create' | 'import-export'`, `showCreationDialog: boolean`
    - Actions: `selectHex(key)` (single select, clears others), `toggleSelectHex(key)` (shift-click add/remove), `clearSelection()`, `setHoveredHex(key | null)`, `setSidePanel(panel)`, `setShowCreationDialog(bool)`
    - IMPORTANT: Always create new Set instances when updating selectedHexes (PITFALL 6)
  </action>
  <verify>
    1. `pnpm -r exec -- npx tsc --noEmit` passes with zero errors
    2. Add a temporary test in App.tsx that imports `createGrid` from `./hex/grid`, creates a 5x5 grid, logs hex count and a sample hex's q,r coordinates -- verify console output shows 25 hexes with correct coordinates
    3. Import `useMapStore` and `useUIStore` in App.tsx, call `useMapStore.getState()` and `useUIStore.getState()` -- verify no runtime errors
    4. Import `MapExportSchema` from `@hex-crawl/shared`, call `MapExportSchema.parse()` with a valid test object -- verify no runtime validation error
    5. Remove temporary test code after verification
  </verify>
  <done>
    All hex math utilities work: GameHex creates flat-top hexes with axial coordinates, createGrid produces a stateful grid, coordinate conversion is available. Shared types compile and validate. Zustand stores initialize with correct defaults. Workspace cross-package imports work (@hex-crawl/shared imported by client).
  </done>
</task>

</tasks>

<verification>
1. `pnpm dev` starts successfully and renders React app
2. TypeScript compiles with zero errors: `pnpm -r exec -- npx tsc --noEmit`
3. All workspace packages linked: `pnpm ls --depth 0` shows @hex-crawl/client, @hex-crawl/shared
4. Honeycomb-grid creates a grid with correct hex count and axial coordinates
5. Zustand stores initialize and update without errors
6. Shared types import correctly from @hex-crawl/shared into client
</verification>

<success_criteria>
- Monorepo scaffold complete with 3 packages (client, shared, server placeholder)
- All Phase 1 dependencies installed (pixi.js, @pixi/react, honeycomb-grid, pixi-viewport, zustand, tailwindcss, zod)
- Flat-top hex grid creation with honeycomb-grid works (GameHex class, createGrid factory)
- Coordinate helpers (hexToPixel, pixelToHex, hexToKey) available
- Terrain types defined (10 built-in types with colors)
- Zustand stores for map state and UI state functional
- Zod schemas for map import/export validation ready
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-hex-grid-foundation/01-01-SUMMARY.md`
</output>
