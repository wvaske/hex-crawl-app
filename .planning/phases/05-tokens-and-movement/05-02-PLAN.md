---
phase: 05-tokens-and-movement
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/server/src/ws/message-handlers.ts
  - packages/server/src/ws/session-manager.ts
  - packages/server/src/routes/map.ts
autonomous: true

must_haves:
  truths:
    - "Server validates token:move adjacency for players and rejects invalid moves"
    - "DM can move any token to any hex (no adjacency restriction)"
    - "Players can only move their own token"
    - "Token CRUD operations persist to database"
    - "Token events broadcast to all connected clients in the campaign"
    - "GET /api/campaigns/:id/map includes tokens (filtered by role: DM sees all, players see visible only)"
  artifacts:
    - path: "packages/server/src/ws/message-handlers.ts"
      provides: "Token message handlers"
      contains: "token:move"
    - path: "packages/server/src/routes/map.ts"
      provides: "Token data in map response"
      contains: "campaignToken"
  key_links:
    - from: "packages/server/src/ws/message-handlers.ts"
      to: "packages/server/src/db/schema/token.ts"
      via: "DB queries for token CRUD"
      pattern: "campaignToken"
    - from: "packages/server/src/ws/message-handlers.ts"
      to: "packages/server/src/ws/session-manager.ts"
      via: "broadcastToAll for token events"
      pattern: "broadcastToAll"
---

<objective>
Implement server-side token handlers: move validation, CRUD operations, persistence, broadcasting, and token data in the map REST endpoint.

Purpose: The server is the authority for all token operations. Moves are validated, persisted, and broadcast. The map endpoint serves initial token state.
Output: Working server-side token logic for all 4 client message types + token data in GET map response.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tokens-and-movement/05-RESEARCH.md
@.planning/phases/05-tokens-and-movement/05-01-SUMMARY.md
@packages/server/src/ws/message-handlers.ts
@packages/server/src/ws/session-manager.ts
@packages/server/src/ws/handler.ts
@packages/server/src/routes/map.ts
@packages/shared/src/ws-messages.ts
@packages/shared/src/hex-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token message handlers to WS message-handlers.ts</name>
  <files>
    packages/server/src/ws/message-handlers.ts
  </files>
  <action>
Add handlers for all 4 client token message types in message-handlers.ts, following the existing pattern for hex:reveal/hex:hide handlers.

**token:move handler:**
1. Load token from DB by tokenId + campaignId
2. Permission: if role === "player" and token.ownerId !== userId, reject with error
3. Adjacency: if role !== "dm", parse both hexKeys, call hexDistance. If distance !== 1, reject with error "Can only move to adjacent hexes"
4. Impassable check: query campaign_hex for toHexKey, check passable column if it exists (add passable boolean default true to campaign_hex if not already present — check first). If not passable and role !== "dm", reject.
5. Update token hexKey in DB
6. Broadcast token:moved to all clients via broadcastToAll

**token:create handler (DM only):**
1. Verify role === "dm"
2. Insert new campaignToken row with provided fields (hexKey, label, icon, color, tokenType, ownerId if provided)
3. Broadcast token:created with full token object to all clients

**token:update handler:**
1. Load token. If role === "player", only allow updating own token's icon (not color, visibility, label)
2. DM can update any field: icon, color, visible, label
3. Update in DB, broadcast token:updated

**token:delete handler (DM only):**
1. Verify role === "dm"
2. Delete token from DB
3. Broadcast token:deleted with tokenId

Import parseHexKey from shared and hexDistance from the existing neighbors/coordinates utilities. Use the same db import pattern as fog-utils.ts.
  </action>
  <verify>`cd packages/server && npx tsc --noEmit` passes. Review the handler code for correct permission checks.</verify>
  <done>All 4 token message handlers implemented with correct permission checks (player owns token, DM can do anything), adjacency validation for player moves, DB persistence, and broadcasting.</done>
</task>

<task type="auto">
  <name>Task 2: Add token data to GET /api/campaigns/:id/map endpoint</name>
  <files>
    packages/server/src/routes/map.ts
    packages/server/src/ws/session-manager.ts
  </files>
  <action>
In the existing GET `/api/campaigns/:id/map` route handler in map.ts:

1. Query all campaign_token rows for the campaign
2. If user role is "player", filter to only tokens where visible = true
3. Include tokens array in the response JSON alongside the existing hex data

The response shape should add: `tokens: Token[]` (using the Token interface from shared).

Also in session-manager.ts, when sending initial session:state on client connect, include a token:state message with the current tokens (same role-based filtering). This ensures WS-connected clients get tokens immediately. Alternatively, if session:state already triggers a map fetch on the client (which it does per 04-04 decision), the REST endpoint addition is sufficient. Choose the simpler approach — just add tokens to the map REST response.
  </action>
  <verify>`cd packages/server && npx tsc --noEmit` passes. Manually test: start the server, create a campaign, call GET /api/campaigns/:id/map — response should include `tokens: []`.</verify>
  <done>GET /api/campaigns/:id/map returns tokens array. DM sees all tokens. Players see only visible tokens.</done>
</task>

</tasks>

<verification>
1. `cd packages/server && npx tsc --noEmit` passes
2. Token move handler rejects non-adjacent moves for players
3. Token move handler allows DM to move to any hex
4. Token create/delete restricted to DM
5. Map endpoint returns tokens array
</verification>

<success_criteria>
- All token WS message types handled server-side
- Player can only move own token to adjacent hex
- DM can move any token to any hex
- Token state persists in PostgreSQL
- Map REST endpoint includes tokens with role-based filtering
</success_criteria>

<output>
After completion, create `.planning/phases/05-tokens-and-movement/05-02-SUMMARY.md`
</output>
