---
phase: 05-tokens-and-movement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/schema/token.ts
  - packages/server/src/db/schema/index.ts
  - packages/server/drizzle.config.ts
  - packages/shared/src/hex-types.ts
  - packages/shared/src/ws-messages.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "campaign_token table exists in PostgreSQL with correct columns"
    - "Token type is exported from shared package"
    - "WS message types for token:move, token:create, token:update, token:delete, token:moved, token:created, token:updated, token:deleted, token:state are defined"
  artifacts:
    - path: "packages/server/src/db/schema/token.ts"
      provides: "campaign_token Drizzle schema"
      contains: "campaignToken"
    - path: "packages/shared/src/hex-types.ts"
      provides: "Token interface"
      contains: "Token"
    - path: "packages/shared/src/ws-messages.ts"
      provides: "Token WS message schemas"
      contains: "token:move"
  key_links:
    - from: "packages/server/src/db/schema/token.ts"
      to: "packages/server/src/db/schema/campaign.ts"
      via: "foreign key reference"
      pattern: "campaign\\.id"
    - from: "packages/server/src/db/schema/index.ts"
      to: "packages/server/src/db/schema/token.ts"
      via: "barrel export"
      pattern: "export.*token"
---

<objective>
Create the data foundation for tokens: database schema, shared TypeScript types, and WebSocket message definitions.

Purpose: Every subsequent plan depends on the token data model, shared types, and message contracts. This must land first.
Output: campaign_token table in DB, Token type in shared, all token WS message schemas.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tokens-and-movement/05-RESEARCH.md
@packages/server/src/db/schema/fog.ts
@packages/server/src/db/schema/campaign.ts
@packages/server/src/db/schema/index.ts
@packages/server/drizzle.config.ts
@packages/shared/src/hex-types.ts
@packages/shared/src/ws-messages.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create campaign_token DB schema and push migration</name>
  <files>
    packages/server/src/db/schema/token.ts
    packages/server/src/db/schema/index.ts
    packages/server/drizzle.config.ts
  </files>
  <action>
Create `packages/server/src/db/schema/token.ts` with a `campaignToken` pgTable following the pattern in fog.ts and hex-data.ts:

```typescript
export const campaignToken = pgTable(
  "campaign_token",
  {
    id: text("id").primaryKey().$defaultFn(() => crypto.randomUUID()),
    campaignId: text("campaign_id").notNull().references(() => campaign.id, { onDelete: "cascade" }),
    hexKey: text("hex_key").notNull(),          // position "q,r"
    ownerId: text("owner_id").references(() => user.id, { onDelete: "set null" }),
    label: text("label").notNull(),
    icon: text("icon").notNull().default("⚔️"),
    color: text("color").notNull().default("#ff0000"),
    tokenType: text("token_type", { enum: ["pc", "npc"] }).notNull().default("pc"),
    visible: boolean("visible").notNull().default(true),
    createdBy: text("created_by").notNull().references(() => user.id),
  },
  (table) => [
    index("campaign_token_campaign_idx").on(table.campaignId),
  ]
);
```

Add `export * from "./token"` to `packages/server/src/db/schema/index.ts`.

Add `"./src/db/schema/token.ts"` to the schema array in `packages/server/drizzle.config.ts`.

Run `cd packages/server && npx drizzle-kit push` to apply the schema to the database.
  </action>
  <verify>Run `npx drizzle-kit push` completes without errors. Run a quick query: `psql` or check that the table exists via a test script.</verify>
  <done>campaign_token table exists in PostgreSQL with all columns (id, campaignId, hexKey, ownerId, label, icon, color, tokenType, visible, createdBy) and the campaign foreign key with cascade delete.</done>
</task>

<task type="auto">
  <name>Task 2: Add Token shared types and WS message schemas</name>
  <files>
    packages/shared/src/hex-types.ts
    packages/shared/src/ws-messages.ts
    packages/shared/src/index.ts
  </files>
  <action>
In `packages/shared/src/hex-types.ts`, add:

```typescript
export interface Token {
  id: string;
  hexKey: string;
  ownerId: string | null;
  label: string;
  icon: string;
  color: string;
  tokenType: "pc" | "npc";
  visible: boolean;
}
```

In `packages/shared/src/ws-messages.ts`, add Zod schemas for all token messages:

Client -> Server:
- `token:move` { tokenId: string, toHexKey: string }
- `token:create` { hexKey: string, label: string, icon: string, color: string, tokenType: "pc"|"npc", ownerId?: string }
- `token:update` { tokenId: string, updates: { icon?, color?, visible?, label? } }
- `token:delete` { tokenId: string }

Server -> Client:
- `token:moved` { tokenId: string, fromHexKey: string, toHexKey: string, movedBy: string }
- `token:created` { token: Token object }
- `token:updated` { tokenId: string, updates: {...} }
- `token:deleted` { tokenId: string }
- `token:state` { tokens: Token[] }

Add these to the existing ClientMessage discriminated union (the client->server ones) and create the server->client types as needed following the existing pattern.

Make sure Token type and all new message types are exported from `packages/shared/src/index.ts`.
  </action>
  <verify>`cd packages/shared && npx tsc --noEmit` passes. All new types and schemas are importable.</verify>
  <done>Token interface exported from shared. All 9 token WS message schemas defined with Zod validation. ClientMessage union includes token:move, token:create, token:update, token:delete.</done>
</task>

</tasks>

<verification>
1. `cd packages/server && npx drizzle-kit push` succeeds (schema applied)
2. `cd packages/shared && npx tsc --noEmit` passes (types valid)
3. `cd packages/server && npx tsc --noEmit` passes (schema imports valid)
</verification>

<success_criteria>
- campaign_token table exists in PostgreSQL
- Token interface is importable from @hexcrawl/shared
- All token WS message schemas are defined and exported
- No TypeScript compilation errors in shared or server packages
</success_criteria>

<output>
After completion, create `.planning/phases/05-tokens-and-movement/05-01-SUMMARY.md`
</output>
