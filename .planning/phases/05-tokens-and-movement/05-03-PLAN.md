---
phase: 05-tokens-and-movement
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/client/src/stores/useTokenStore.ts
  - packages/client/src/canvas/layers/TokenLayer.tsx
  - packages/client/src/canvas/TokenSprite.ts
  - packages/client/src/components/MapView.tsx
autonomous: true

must_haves:
  truths:
    - "Tokens render on the hex map at correct hex center positions"
    - "Multiple tokens on the same hex shrink and arrange side by side"
    - "Each token shows an icon/emoji with a colored ring border"
    - "Token store updates trigger re-renders of the token layer"
    - "Players do not see tokens where visible=false"
  artifacts:
    - path: "packages/client/src/stores/useTokenStore.ts"
      provides: "Token state management"
      exports: ["useTokenStore"]
    - path: "packages/client/src/canvas/layers/TokenLayer.tsx"
      provides: "PixiJS token rendering layer"
      exports: ["TokenLayer"]
    - path: "packages/client/src/canvas/TokenSprite.ts"
      provides: "Token display object factory and layout"
      exports: ["createTokenDisplayObject", "layoutTokensInHex"]
  key_links:
    - from: "packages/client/src/canvas/layers/TokenLayer.tsx"
      to: "packages/client/src/stores/useTokenStore.ts"
      via: "useTokenStore subscription"
      pattern: "useTokenStore"
    - from: "packages/client/src/components/MapView.tsx"
      to: "packages/client/src/canvas/layers/TokenLayer.tsx"
      via: "JSX child in render tree"
      pattern: "TokenLayer"
---

<objective>
Create the client-side token store and PixiJS rendering layer so tokens appear on the map at correct positions.

Purpose: Tokens must be visible on the map before drag interaction can be built. This plan creates the rendering pipeline.
Output: useTokenStore, TokenLayer component, token display object factory — tokens render at hex centers.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tokens-and-movement/05-RESEARCH.md
@.planning/phases/05-tokens-and-movement/05-01-SUMMARY.md
@packages/client/src/stores/useMapStore.ts
@packages/client/src/stores/useSessionStore.ts
@packages/client/src/canvas/layers/TerrainLayer.tsx
@packages/client/src/canvas/layers/FogLayer.tsx
@packages/client/src/canvas/HexSprite.ts
@packages/client/src/components/MapView.tsx
@packages/shared/src/hex-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTokenStore and token display utilities</name>
  <files>
    packages/client/src/stores/useTokenStore.ts
    packages/client/src/canvas/TokenSprite.ts
  </files>
  <action>
**useTokenStore.ts** — Create a Zustand store following the pattern of useMapStore/useSessionStore:

```typescript
interface TokenState {
  tokens: Map<string, Token>;  // keyed by token.id
  setTokens: (tokens: Token[]) => void;
  moveToken: (tokenId: string, newHexKey: string) => void;
  addToken: (token: Token) => void;
  removeToken: (tokenId: string) => void;
  updateToken: (tokenId: string, updates: Partial<Token>) => void;
  clearTokens: () => void;
}
```

IMPORTANT: Follow the [01-01] decision — always create `new Map(state.tokens)` before mutating for Zustand reactivity. Import the Token type from @hexcrawl/shared.

**TokenSprite.ts** — Create helper functions (imperative, NOT React components):

1. `createTokenDisplayObject(token: Token, hexSize: number): Container` — Creates a PixiJS Container with:
   - A Graphics circle with colored fill (token.color at alpha 0.25) and colored stroke (token.color, width 3) for the ring
   - A Text child centered in the ring showing token.icon (emoji)
   - Radius = hexSize * 0.35

2. `layoutTokensInHex(count: number, hexSize: number): Array<{x: number, y: number, scale: number}>` — Returns relative offsets for positioning multiple tokens within a hex:
   - 1 token: center, scale 1
   - 2 tokens: side by side, scale 0.65
   - 3+ tokens: circular arrangement, progressively smaller scale

3. `updateTokenDisplayObject(container: Container, token: Token, hexSize: number): void` — Updates an existing container's icon text and ring color (for token:updated events).
  </action>
  <verify>`cd packages/client && npx tsc --noEmit` passes.</verify>
  <done>useTokenStore manages token state with reactive Map updates. TokenSprite.ts creates/updates PixiJS display objects for tokens with colored rings and emoji icons. Multi-token layout positions tokens within a hex.</done>
</task>

<task type="auto">
  <name>Task 2: Create TokenLayer and integrate into MapView</name>
  <files>
    packages/client/src/canvas/layers/TokenLayer.tsx
    packages/client/src/components/MapView.tsx
  </files>
  <action>
**TokenLayer.tsx** — Create a PixiJS layer component following the imperative pattern of TerrainLayer.tsx (NOT per-token React components — that's an anti-pattern per research).

1. Use a `containerRef` for the parent Container and a `tokenDisplaysRef` Map for tracking per-token display objects
2. Subscribe to useTokenStore tokens, useMapStore hexSize, useSessionStore userRole
3. On token state change:
   - Remove stale display objects (tokens that no longer exist)
   - Filter out hidden tokens for players (visible === false)
   - Group remaining tokens by hexKey
   - For each hex group, compute hex center using hexCenterWorld (or the same coordinate utility used by other layers), then call layoutTokensInHex for offsets
   - Create new display objects (createTokenDisplayObject) for new tokens, update positions for existing ones
4. Use `<pixiContainer ref={...} />` as the JSX return (same as other layers)

**MapView.tsx** — Add TokenLayer as a child in the viewport, between FogLayer and HighlightLayer (z-order per research: Terrain, Grid, Fog, **Token**, Highlight, UI). Import TokenLayer and place it in the JSX tree.

Also wire up token data loading: in the existing map data fetch (triggered after session:state), parse the `tokens` array from the response and call `useTokenStore.getState().setTokens(data.tokens)` to populate the store.
  </action>
  <verify>`cd packages/client && npx tsc --noEmit` passes. Start the app, create a campaign — MapView renders without errors (no tokens yet, but no crashes).</verify>
  <done>TokenLayer renders tokens at correct hex positions. Multiple tokens per hex use shrink-and-arrange layout. Hidden tokens are filtered for players. TokenLayer sits between Fog and Highlight layers in z-order. Token data loads from map endpoint into store.</done>
</task>

</tasks>

<verification>
1. `cd packages/client && npx tsc --noEmit` passes
2. TokenLayer renders without errors when token store is empty
3. TokenLayer renders without errors when token store has tokens (will be testable after server plan completes)
4. Layer z-order: Terrain < Grid < Fog < Token < Highlight < UI
</verification>

<success_criteria>
- Tokens render at correct hex center positions with icon + colored ring
- Multi-token layout works (2 tokens side by side, 3+ circular)
- Players see only visible tokens
- Token store follows Zustand Map reactivity pattern
- TokenLayer integrated in MapView at correct z-order
</success_criteria>

<output>
After completion, create `.planning/phases/05-tokens-and-movement/05-03-SUMMARY.md`
</output>
