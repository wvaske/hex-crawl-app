---
phase: 05-tokens-and-movement
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - packages/client/src/canvas/HexInteraction.tsx
  - packages/client/src/components/SidePanel.tsx
  - packages/client/src/stores/useSessionStore.ts
autonomous: true

must_haves:
  truths:
    - "Player can drag their own token to an adjacent hex and it snaps to center"
    - "Dragging a token does not pan the viewport"
    - "Invalid move (non-adjacent, impassable) snaps token back to original position"
    - "Token move animates smoothly (~200ms) from old hex to new hex"
    - "When one player moves a token, all other connected clients see the token move"
    - "DM can create tokens via UI and assign them to players"
    - "DM can drag any token to any hex"
    - "Players cannot drag other players' tokens"
    - "Token positions persist across page reload"
  artifacts:
    - path: "packages/client/src/canvas/HexInteraction.tsx"
      provides: "Token drag interaction"
      contains: "tokenDrag"
    - path: "packages/client/src/components/SidePanel.tsx"
      provides: "DM token creation UI"
      contains: "token:create"
  key_links:
    - from: "packages/client/src/canvas/HexInteraction.tsx"
      to: "packages/client/src/stores/useTokenStore.ts"
      via: "token hit-testing and optimistic move"
      pattern: "useTokenStore"
    - from: "packages/client/src/canvas/HexInteraction.tsx"
      to: "packages/client/src/stores/useSessionStore.ts"
      via: "sendMessage for token:move"
      pattern: "sendMessage.*token:move"
    - from: "packages/client/src/components/SidePanel.tsx"
      to: "packages/client/src/stores/useSessionStore.ts"
      via: "sendMessage for token:create"
      pattern: "sendMessage.*token:create"
---

<objective>
Implement token drag-to-move interaction, smooth animation, WS message wiring, and DM token creation UI. This is the integration plan that makes tokens fully interactive.

Purpose: This connects all the pieces ‚Äî the user can now grab a token, drag it to a hex, see it animate, and all connected clients see the move.
Output: Working token drag interaction, smooth animation, DM create/manage UI, full real-time sync.
</objective>

<execution_context>
@/home/developer/.claude/get-shit-done/workflows/execute-plan.md
@/home/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tokens-and-movement/05-RESEARCH.md
@.planning/phases/05-tokens-and-movement/05-02-SUMMARY.md
@.planning/phases/05-tokens-and-movement/05-03-SUMMARY.md
@packages/client/src/canvas/HexInteraction.tsx
@packages/client/src/canvas/ViewportContext.tsx
@packages/client/src/components/SidePanel.tsx
@packages/client/src/stores/useTokenStore.ts
@packages/client/src/stores/useSessionStore.ts
@packages/client/src/stores/useMapStore.ts
@packages/client/src/canvas/TokenSprite.ts
@packages/client/src/canvas/layers/TokenLayer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Token drag interaction and move animation in HexInteraction</name>
  <files>
    packages/client/src/canvas/HexInteraction.tsx
    packages/client/src/stores/useSessionStore.ts
  </files>
  <action>
Extend HexInteraction.tsx to handle token dragging. This integrates with the existing pointerdown/pointermove/pointerup flow.

**pointerdown changes:**
1. Convert pointer to world coords (existing viewport.toWorld)
2. Hit-test all tokens: for each token in useTokenStore, compute its world position (hexCenterWorld + layout offset). Check if pointer distance is within token radius (hexSize * 0.35 * token's layout scale). Test closer tokens first.
3. If a token is hit:
   - Check permissions: player can only drag own token (token.ownerId === current userId). DM can drag any token.
   - If permitted: set dragging state (draggingTokenId, dragStartHexKey, dragStartWorldPos), pause viewport drag plugin (`viewport.plugins.pause('drag')`), and skip hex selection
   - If not permitted: fall through to normal hex click/select
4. If no token hit: existing hex click/select behavior unchanged

**pointermove changes:**
If dragging a token:
- Move the token's display object to follow the cursor (world coords). Access the token display container from TokenLayer's display map (expose via a ref or module-level variable, following the ViewportContext pattern).
- Highlight valid adjacent hexes (the 6 neighbors of the token's start hex) with a subtle glow or tint. Skip this if DM (DM can move anywhere).

**pointerup changes:**
If dragging a token:
1. Compute target hex from pointer world coords using pixelToHex
2. Client-side validation: if player and target is not adjacent to start hex, animate token back to start position (snap back)
3. If valid (or DM): send `token:move` message via sendMessage, optimistically animate token to target hex center using smooth animation (~200ms ease-out quad, use PixiJS app.ticker)
4. Resume viewport drag plugin
5. Clear dragging state

**WS message handling in useSessionStore (or wherever incoming WS messages are dispatched):**
Wire up incoming token messages to the token store:
- `token:moved`: call `useTokenStore.getState().moveToken(tokenId, toHexKey)` ‚Äî TokenLayer will re-render and animate
- `token:created`: call `useTokenStore.getState().addToken(token)`
- `token:updated`: call `useTokenStore.getState().updateToken(tokenId, updates)`
- `token:deleted`: call `useTokenStore.getState().removeToken(tokenId)`

For the `token:moved` message from another user (not the current user who initiated the drag), TokenLayer should animate the token smoothly from old position to new position. Add an `animateTokenMove` function using the PixiJS ticker pattern from research (ease-out quad, ~200ms).

**Snap-back on server rejection:** If server sends an error response for a token:move, animate the token back to its original hex. Track pending moves per token to prevent double-drag during network latency.
  </action>
  <verify>`cd packages/client && npx tsc --noEmit` passes. Manual test: open app as DM, create a token (via next task's UI), drag it to adjacent hex ‚Äî token animates smoothly. Open a second browser as player, see token move in real time.</verify>
  <done>Token drag works: pointerdown hit-tests tokens, pointermove shows token following cursor, pointerup validates and sends WS message. Viewport drag is paused during token drag. Invalid moves snap back. Incoming token WS messages update the store and trigger re-render with animation.</done>
</task>

<task type="auto">
  <name>Task 2: DM token creation and management UI</name>
  <files>
    packages/client/src/components/SidePanel.tsx
  </files>
  <action>
Add a "Tokens" tab to the SidePanel (visible to DM only). The tab should contain:

**Token Creation Form:**
- Label text input (token name, e.g., "Goblin Guard")
- Icon picker: a grid of ~16 common RPG emoji (‚öîÔ∏è, üõ°Ô∏è, üèπ, üßô, üêâ, üëπ, üßù, üè∞, ‚≠ê, üíÄ, üî•, üå≤, üëë, üó°Ô∏è, üê∫, üé≠)
- Color picker: 8 preset colors in a row (red, blue, green, yellow, purple, orange, cyan, pink) ‚Äî simple div buttons with colored backgrounds
- Token type: toggle between "PC" and "NPC"
- If PC: dropdown to assign to a campaign member (fetch member list from session store)
- "Place Token" button ‚Äî sends `token:create` via WS with the selected hex as hexKey (use the currently selected hex from useMapStore). If no hex selected, show a message "Select a hex first"

**Token List:**
- Show all tokens in the campaign (from useTokenStore)
- Each row: icon + colored dot + label + type badge (PC/NPC)
- For each token: toggle visibility button (eye icon), delete button (trash icon)
- Clicking visibility sends `token:update` with `{ visible: !current }`
- Clicking delete sends `token:delete`

Style with Tailwind following the existing SidePanel dark theme (bg-gray-800, text-gray-100, etc. per [01-03] decision).
  </action>
  <verify>`cd packages/client && npx tsc --noEmit` passes. Manual test: open app as DM, go to Tokens tab, fill form, select a hex, click "Place Token" ‚Äî token appears on hex.</verify>
  <done>DM can create tokens via SidePanel form with label, icon, color, type, and optional player assignment. DM can toggle token visibility and delete tokens from the token list. Token operations send correct WS messages.</done>
</task>

</tasks>

<verification>
1. `cd packages/client && npx tsc --noEmit` passes
2. Full flow: DM creates token ‚Üí token appears on map ‚Üí player sees token ‚Üí player drags token to adjacent hex ‚Üí DM sees token move ‚Üí token position persists after reload
3. Player cannot drag DM's NPC token
4. Player cannot drag another player's token
5. DM can drag any token to any hex (including non-adjacent)
6. Invalid player move snaps token back
7. Viewport does not pan during token drag
</verification>

<success_criteria>
- Token drag-to-move works with smooth animation
- Viewport drag paused during token drag (no pan conflict)
- Real-time sync: all clients see token moves
- DM creation UI: label, icon, color, type, assignment
- DM visibility toggle and delete from token list
- Permission enforcement: players move only own tokens
- Positions persist across reload (via map endpoint ‚Üí store)
</success_criteria>

<output>
After completion, create `.planning/phases/05-tokens-and-movement/05-04-SUMMARY.md`
</output>
